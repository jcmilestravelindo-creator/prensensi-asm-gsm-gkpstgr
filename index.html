<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance GKPS Tangerang - Pro System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        :root {
            --color-primary: #0ea5e9; --color-primary-dark: #0284c7;
            --color-accent: #facc15; --color-bg-soft: #f0f9ff;
            --color-text-dark: #1e293b; --color-text-muted: #64748b;
        }
        body { font-family: 'Poppins', sans-serif; color: var(--color-text-dark); background: linear-gradient(to bottom, #e0f2fe, #f0f9ff); min-height: 100vh; padding-bottom: 3rem; }
        
        .pro-card { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 30px -5px rgba(14, 165, 233, 0.15); border: 1px solid #e2e8f0; }
        
        .nav-btn { padding: 0.75rem 1.5rem; border-radius: 9999px; transition: all 0.2s; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .nav-btn.active { background: var(--color-primary); color: white; box-shadow: 0 4px 12px -2px rgba(14, 165, 233, 0.5); }
        .nav-btn.inactive { background: white; color: var(--color-text-muted); }

        .pro-input, .pro-select { width: 100%; padding: 0.8rem; border: 2px solid #e2e8f0; border-radius: 1rem; background: #f8fafc; }
        .pro-btn { background: var(--color-primary); color: white; font-weight: 700; padding: 1rem; border-radius: 1rem; width: 100%; transition: all 0.2s; }
        .pro-btn:hover { background: var(--color-primary-dark); }

        .avatar-selection { width: 60px; height: 60px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; }
        .avatar-selection.selected { border-color: var(--color-accent); transform: scale(1.1); }

        .pro-id-card { width: 320px; background: linear-gradient(135deg, #0284c7, #0ea5e9); border-radius: 1.5rem; padding: 2rem; color: white; text-align: center; position: relative; overflow: hidden; }
        .scanner-frame { border-radius: 1.5rem; overflow: hidden; border: 4px solid var(--color-primary-dark); position: relative; }
        
        .role-badge { padding: 0.2rem 0.8rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .role-guru { background: #dbeafe; color: #1e40af; } .role-anak { background: #dcfce7; color: #166534; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-900">GKPS TANGERANG</h1>
            <p class="text-gray-600">Sistem Absensi Sekolah Minggu Pro</p>
        </header>

        <div class="flex justify-center mb-8 gap-2 flex-wrap">
            <button onclick="switchNav('home')" id="nav-home" class="nav-btn active">Beranda</button>
            <button onclick="switchNav('register')" id="nav-register" class="nav-btn inactive">Pendaftaran</button>
            <button onclick="switchNav('scan')" id="nav-scan" class="nav-btn inactive">Scan</button>
            <button onclick="switchNav('admin')" id="nav-admin" class="nav-btn inactive">Admin & Data</button>
        </div>

        <section id="home" class="section">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="pro-card text-center">
                    <h2 class="text-2xl font-bold text-blue-900 mb-2">Selamat Hari Minggu!</h2>
                    <p class="text-gray-600 mb-4">Siapkan ID Card untuk absensi.</p>
                    <div class="text-5xl font-extrabold text-blue-600 mb-2" id="stat-count">0</div>
                    <p class="text-sm font-bold text-gray-500">Jiwa Hadir Hari Ini</p>
                </div>
                <div class="pro-card">
                    <h3 class="font-bold text-gray-800 mb-4">Peserta Terbaru</h3>
                    <div class="flex flex-wrap gap-2" id="today-avatars-list"></div>
                </div>
            </div>
        </section>

        <section id="register" class="section hidden">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="pro-card">
                    <h2 class="text-2xl font-bold mb-4">Registrasi Baru</h2>
                    <div class="space-y-4">
                        <input type="text" id="reg-name" class="pro-input" placeholder="Nama Lengkap">
                        <select id="reg-role" class="pro-select">
                            <option value="Anak">Anak Sekolah Minggu</option>
                            <option value="Guru">Guru Sekolah Minggu</option>
                        </select>
                        <div>
                            <p class="text-sm font-bold mb-2">Pilih Avatar:</p>
                            <div class="flex gap-2 overflow-x-auto pb-2" id="avatar-list"></div>
                        </div>
                        <button onclick="registerUser()" class="pro-btn">Buat ID Card</button>
                    </div>
                </div>
                <div id="id-card-result" class="hidden flex flex-col items-center">
                    <div class="pro-id-card">
                        <div class="text-sm font-bold tracking-widest mb-4 opacity-80">GKPS TANGERANG</div>
                        <img id="card-avatar" src="" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white">
                        <h2 id="card-name" class="text-2xl font-bold uppercase mb-1">Nama</h2>
                        <span id="card-role" class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold">ROLE</span>
                        <div class="bg-white p-2 mt-6 rounded-lg"><svg id="barcode" class="w-full"></svg></div>
                    </div>
                    <button onclick="window.print()" class="mt-4 text-blue-600 font-bold underline">Cetak ID Card</button>
                </div>
            </div>
        </section>

        <section id="scan" class="section hidden">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="pro-card">
                    <h2 class="text-xl font-bold mb-4 text-center">Scan Barcode</h2>
                    <div class="scanner-frame bg-black h-64">
                        <div id="reader"></div>
                    </div>
                    <div id="scan-result" class="mt-4 text-center p-4 rounded-xl hidden font-bold"></div>
                </div>
                <div class="pro-card">
                    <h3 class="font-bold mb-4">Log Scan Hari Ini</h3>
                    <div id="recent-scan-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <div class="pro-card mb-6">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Data Absensi (Hadir)</h2>
                <div class="overflow-x-auto mb-4">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100"><tr><th class="p-3">Nama</th><th class="p-3">Peran</th><th class="p-3">Waktu</th></tr></thead>
                        <tbody id="attendance-table-body"></tbody>
                    </table>
                </div>
                <button onclick="exportAttendance()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Download Absensi (Excel)</button>
                <button onclick="clearAttendance()" class="text-red-500 text-sm ml-4 underline">Reset Absensi</button>
            </div>

            <div class="pro-card bg-blue-50 border-blue-200">
                <h2 class="text-xl font-bold mb-4 text-blue-900 border-b border-blue-200 pb-2">2. Database Jemaat Terdaftar</h2>
                <p class="text-sm text-gray-600 mb-4">Ini adalah data yang tersimpan di perangkat ini. Jika scan gagal, pastikan nama ada di list ini.</p>
                <div class="overflow-x-auto mb-4 max-h-60 overflow-y-auto bg-white rounded-lg border">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-blue-100 text-blue-900"><tr><th class="p-3">Avatar</th><th class="p-3">Nama Lengkap</th><th class="p-3">Peran</th><th class="p-3">ID System</th></tr></thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Backup Database User</button>
                    <label class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer hover:bg-gray-700">
                        Restore Database User
                        <input type="file" id="import-file" class="hidden" onchange="importUsers(this)">
                    </label>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- DATA ---
        let users = JSON.parse(localStorage.getItem('gkps_users')) || [];
        let attendance = JSON.parse(localStorage.getItem('gkps_attendance')) || [];
        let selectedAvatar = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix';

        // --- SETUP AVATAR ---
        const seeds = ['Felix', 'Aneka', 'Boo', 'Buddy', 'Cookie', 'Daisy', 'Tigger', 'Molly', 'Coco', 'Simba'];
        const listDiv = document.getElementById('avatar-list');
        seeds.forEach((s, i) => {
            const url = `https://api.dicebear.com/7.x/adventurer/svg?seed=${s}`;
            const img = document.createElement('img');
            img.src = url; img.className = `avatar-selection ${i===0?'selected':''}`;
            img.onclick = () => {
                selectedAvatar = url;
                document.querySelectorAll('.avatar-selection').forEach(el=>el.classList.remove('selected'));
                img.classList.add('selected');
            };
            listDiv.appendChild(img);
        });

        // --- NAVIGATION ---
        function switchNav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); b.classList.add('inactive'); });
            document.getElementById('nav-'+id).classList.add('active');
            document.getElementById('nav-'+id).classList.remove('inactive');

            if(id === 'admin') { renderAttendance(); renderUsersList(); }
            if(id === 'home') updateStats();
            if(id === 'scan') startScanner(); else stopScanner();
        }

        // --- REGISTER ---
        function registerUser() {
            const name = document.getElementById('reg-name').value;
            const role = document.getElementById('reg-role').value;
            if(!name) return alert('Nama wajib diisi!');

            const id = 'GKPS-' + Date.now(); // Unique ID
            users.push({ id, name, role, avatar: selectedAvatar });
            localStorage.setItem('gkps_users', JSON.stringify(users));

            // Show Result
            document.getElementById('id-card-result').classList.remove('hidden');
            document.getElementById('card-name').innerText = name;
            document.getElementById('card-role').innerText = role;
            document.getElementById('card-avatar').src = selectedAvatar;
            JsBarcode("#barcode", id, { format: "CODE128", width: 2, height: 50, displayValue: true });
            
            alert('Pendaftaran Berhasil! Data tersimpan di perangkat ini.');
            document.getElementById('reg-name').value = '';
            renderUsersList(); // Update user list in admin immediately
        }

        // --- SCANNER ---
        let scanner;
        function startScanner() {
            if(scanner) return;
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 });
            scanner.render(onScanSuccess);
        }
        function stopScanner() { if(scanner) { scanner.clear(); scanner = null; } }

        function onScanSuccess(decodedText) {
            const user = users.find(u => u.id === decodedText);
            const resDiv = document.getElementById('scan-result');
            resDiv.classList.remove('hidden');

            if(!user) {
                resDiv.className = "mt-4 p-4 bg-red-100 text-red-800 rounded-xl border border-red-300";
                resDiv.innerText = "❌ GAGAL: Barcode tidak ditemukan di perangkat ini. (Cek Database User)";
                return;
            }

            const today = new Date().toLocaleDateString();
            const existing = attendance.find(a => a.id === decodedText && a.date === today);

            if(existing) {
                resDiv.className = "mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-xl border border-yellow-300";
                resDiv.innerText = `⚠️ ${user.name} sudah absen jam ${existing.time}`;
            } else {
                const now = new Date();
                attendance.push({
                    id: decodedText, name: user.name, role: user.role, avatar: user.avatar,
                    date: today, time: now.toLocaleTimeString()
                });
                localStorage.setItem('gkps_attendance', JSON.stringify(attendance));
                
                resDiv.className = "mt-4 p-4 bg-green-100 text-green-800 rounded-xl border border-green-300";
                resDiv.innerText = `✅ SUKSES! Selamat Datang ${user.name}`;
                updateStats();
                renderRecentScans();
            }
            setTimeout(() => resDiv.classList.add('hidden'), 3000);
        }

        function renderRecentScans() {
            const list = document.getElementById('recent-scan-list');
            const today = new Date().toLocaleDateString();
            const data = attendance.filter(a => a.date === today).reverse().slice(0, 5);
            list.innerHTML = data.map(d => `
                <div class="flex items-center bg-gray-50 p-2 rounded-lg border">
                    <img src="${d.avatar}" class="w-8 h-8 rounded-full mr-2">
                    <div><div class="font-bold text-sm">${d.name}</div><div class="text-xs text-gray-500">${d.time}</div></div>
                </div>
            `).join('') || '<div class="text-gray-400 text-sm italic">Belum ada scan.</div>';
        }

        // --- ADMIN & DATA ---
        function renderAttendance() {
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = attendance.slice().reverse().map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold">${r.name}</td>
                    <td class="p-3"><span class="role-badge ${r.role==='Guru'?'role-guru':'role-anak'}">${r.role}</span></td>
                    <td class="p-3 text-gray-500">${r.date} ${r.time}</td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="p-4 text-center text-gray-400">Kosong</td></tr>';
        }

        // New Feature: Render Registered Users List
        function renderUsersList() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = users.map(u => `
                <tr class="border-b hover:bg-blue-50">
                    <td class="p-2"><img src="${u.avatar}" class="w-8 h-8 rounded-full"></td>
                    <td class="p-2 font-bold text-gray-700">${u.name}</td>
                    <td class="p-2 text-sm">${u.role}</td>
                    <td class="p-2 text-xs text-gray-400 font-mono">${u.id}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada user terdaftar di perangkat ini.</td></tr>';
        }

        function updateStats() {
            const today = new Date().toLocaleDateString();
            const count = attendance.filter(a => a.date === today).length;
            document.getElementById('stat-count').innerText = count;
            document.getElementById('today-avatars-list').innerHTML = attendance.filter(a=>a.date===today).map(a=>`<img src="${a.avatar}" class="w-10 h-10 rounded-full border border-white shadow-sm" title="${a.name}">`).join('');
        }

        // --- EXPORT / IMPORT (SOLUSI BEDA DEVICE) ---
        function exportAttendance() {
            downloadCSV(attendance, `Absensi_GKPS_${new Date().toLocaleDateString()}.csv`);
        }
        function exportUsers() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "BACKUP_DATABASE_USER_GKPS.json");
            node.click();
        }
        function importUsers(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        // Merge strategies: prevent duplicates by ID
                        const existingIds = new Set(users.map(u => u.id));
                        let addedCount = 0;
                        imported.forEach(u => {
                            if(!existingIds.has(u.id)) {
                                users.push(u);
                                addedCount++;
                            }
                        });
                        localStorage.setItem('gkps_users', JSON.stringify(users));
                        alert(`Berhasil memulihkan database! ${addedCount} user baru ditambahkan.`);
                        renderUsersList();
                    }
                } catch(err) { alert("File rusak atau salah format."); }
            };
            reader.readAsText(file);
        }

        function downloadCSV(data, filename) {
            let csv = "Nama,Peran,Tanggal,Jam\n";
            data.forEach(row => csv += `${row.name},${row.role},${row.date||''},${row.time||''}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        }

        function clearAttendance() {
            if(confirm('Hapus Log Absensi? Data User tetap aman.')) {
                attendance = []; localStorage.setItem('gkps_attendance', JSON.stringify(attendance));
                renderAttendance(); updateStats();
            }
        }

        // Init
        switchNav('home');
    </script>
</body>
</html>
