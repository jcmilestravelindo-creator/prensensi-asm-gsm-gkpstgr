<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Presensi ASM-GSM GKPS Tangerang (Online Full)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.65)',
                        glassBorder: 'rgba(255, 255, 255, 0.6)',
                        primary: '#6366f1', 
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'Inter', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            'from': { opacity: 0, transform: 'translateY(40px)' },
                            'to': { opacity: 1, transform: 'translateY(0)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- External Libs -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        body { 
            overscroll-behavior-y: none;
            background-color: #f0f2f5; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05);
        }

        @keyframes scan-line {
            0% { top: 10%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }
        .animate-scan { animation: scan-line 2.5s ease-in-out infinite; }

        #reader video { 
            object-fit: cover;
            border-radius: 1.5rem; 
            width: 100% !important;
            height: 100% !important;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 24px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <!-- Import Map: FIXED to use gstatic for Firebase to ensure registration works -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0?deps=react@18.2.0",
            "react-router-dom": "https://esm.sh/react-router-dom@6.22.0?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
            "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
            "react-qr-code": "https://esm.sh/react-qr-code@2.0.12?deps=react@18.2.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
        }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { HashRouter, Routes, Route, useNavigate, useLocation } from 'react-router-dom';
        import { 
            LayoutDashboard, QrCode, Users, BarChart3, LogOut, Church, CreditCard,
            CheckCircle, AlertCircle, Camera, Trash2, Download, Search, Upload,
            ChevronRight, Calendar, User, ShieldCheck, Sparkles, Zap, Plus, X, RefreshCw, BookOpen, PenTool,
            Bell, Activity, MessageSquare, Send, Radio, TrendingUp, Briefcase, GraduationCap, Clock, FileText, CalendarDays, MapPin, Edit, BrainCircuit, Cloud, CloudOff, FileSpreadsheet, File, Lock, Key, Power, Eye, Timer, Wifi, WifiOff, Database
        } from 'lucide-react';
        import { BarChart, Bar, ResponsiveContainer, PieChart, Pie, Cell, Tooltip, XAxis, YAxis, CartesianGrid } from 'recharts';
        import QRCode from 'react-qr-code';
        
        // --- FIREBASE INTEGRATION ---
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, onSnapshot } from "firebase/firestore";

        // --- KONFIGURASI DATABASE (ONLINE) ---
        // PENTING: Ganti dengan konfigurasi Firebase Anda sendiri!
        const firebaseConfig = {
            apiKey: "AIzaSyDDtjCJO09qP3kwOcoctObU-qOg-GTnrTE", // Paste API Key Anda di sini
            authDomain: "sundayschoolattendance-58661.firebaseapp.com",
            projectId: "sundayschoolattendance-58661",
            storageBucket: "sundayschoolattendance-58661.firebasestorage.app",
            messagingSenderId: "1055300658311",
            appId: "1:1055300658311:web:2db2708b0c8bfa5aa54422",
            measurementId: "G-PCB8J7RRHJ"
        };

        // Initialize Firebase
        let app, auth, db, analytics;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
        
        // --- APP ID FOR PATHING (FIXED) ---
        const appId = 'gkps-tangerang-v3-prod';

        const getCollectionRef = (colName) => {
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        };

        const getDocRef = (colName, docId) => {
            return doc(db, 'artifacts', appId, 'public', 'data', colName, String(docId));
        };

        // --- TIMEZONE FIX HELPER ---
        const getLocalDate = () => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const wibTime = new Date(utc + (7 * 3600000));
            
            const year = wibTime.getFullYear();
            const month = String(wibTime.getMonth() + 1).padStart(2, '0');
            const day = String(wibTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- SERVICES (MODIFIED FOR FIREBASE) ---
        // Helper to check if online
        const isConnected = () => auth && auth.currentUser;

        // Helper untuk sync
        const syncFromFirestore = async () => {
            if (!auth.currentUser) return -1;
            
            const collections = [
                { name: 'users', key: 'gkps_users_v3' },
                { name: 'attendance', key: 'gkps_att_v3' },
                { name: 'schedules', key: 'gkps_sched_v3' },
                { name: 'materials', key: 'gkps_mat_v3' },
                { name: 'activities', key: 'gkps_act_v3' },
                { name: 'notifications', key: 'gkps_notif_v3' }
            ];
            let totalDocs = 0; 
            try {
                for (const col of collections) {
                    const querySnapshot = await getDocs(getCollectionRef(col.name));
                    const data = [];
                    querySnapshot.forEach((doc) => {
                        data.push(doc.data());
                    });
                    if (data.length > 0) {
                        localStorage.setItem(col.key, JSON.stringify(data));
                        totalDocs += data.length;
                    }
                }
                return totalDocs; 
            } catch (e) {
                console.error("Gagal sinkronisasi data:", e);
                return -1; 
            }
        };

        const DB = {
            get: (key, def) => {
                try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; }
            },
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            users: {
                update: (updatedUser) => {
                    const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
                    const index = users.findIndex(u => u.id === updatedUser.id);
                    if (index !== -1) {
                        users[index] = updatedUser;
                        DB.set(STORAGE.USERS, users);
                    } else {
                        users.push(updatedUser);
                        DB.set(STORAGE.USERS, users);
                    }
                    if(isConnected()) setDoc(getDocRef('users', updatedUser.id), updatedUser).catch(console.error);
                    return true;
                },
                add: (newUser) => {
                    const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
                    users.push(newUser);
                    DB.set(STORAGE.USERS, users);
                    if(isConnected()) setDoc(getDocRef('users', newUser.id), newUser).catch(console.error);
                },
                delete: (id) => {
                    const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
                    const updated = users.filter(u => u.id !== id);
                    DB.set(STORAGE.USERS, updated);
                    if(isConnected()) deleteDoc(getDocRef('users', id)).catch(console.error);
                }
            },
            att: {
                add: (record) => {
                    const all = DB.get(STORAGE.ATTENDANCE, []);
                    const isDuplicate = all.some(r => r.userId === record.userId && r.date === record.date);
                    if (isDuplicate) return { success: false, reason: 'duplicate' };
                    
                    const newAttendance = [...all, record];
                    DB.set(STORAGE.ATTENDANCE, newAttendance);
                    
                    if(isConnected()) {
                        setDoc(getDocRef('attendance', record.id), record)
                            .then(() => console.log("Absen tersimpan online"))
                            .catch(e => console.error("Gagal simpan online:", e));
                    }
                    return { success: true, reason: 'ok' };
                }
            },
            materials: {
                getLatest: (className) => {
                    const all = DB.get(STORAGE.MATERIALS, []);
                    const classMaterials = all.filter(m => m.className === className);
                    return classMaterials.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                },
                save: (material) => {
                    const all = DB.get(STORAGE.MATERIALS, []);
                    DB.set(STORAGE.MATERIALS, [material, ...all]);
                    if(isConnected()) setDoc(getDocRef('materials', material.id), material).catch(console.error);
                }
            },
            activities: {
                add: (userName, action) => {
                    const all = DB.get(STORAGE.ACTIVITIES, []);
                    const newLog = { id: Date.now(), userName, action, timestamp: new Date().toISOString() };
                    DB.set(STORAGE.ACTIVITIES, [newLog, ...all].slice(0, 50));
                    if(isConnected()) setDoc(getDocRef('activities', newLog.id), newLog).catch(console.error);
                },
                get: () => DB.get(STORAGE.ACTIVITIES, [])
            },
            notifications: {
                broadcast: (title, message, sender, scheduledTime = null) => {
                    const all = DB.get(STORAGE.NOTIFICATIONS, []);
                    const newNotif = { 
                        id: Date.now(), 
                        title, message, sender, 
                        timestamp: new Date().toISOString(),
                        scheduledTime: scheduledTime ? scheduledTime : new Date().toISOString(),
                        status: scheduledTime && new Date(scheduledTime) > new Date() ? 'scheduled' : 'sent'
                    };
                    DB.set(STORAGE.NOTIFICATIONS, [newNotif, ...all]);
                    if(isConnected()) setDoc(getDocRef('notifications', newNotif.id), newNotif).catch(console.error);
                },
                get: () => DB.get(STORAGE.NOTIFICATIONS, [])
            },
            schedules: {
                get: (className) => {
                    const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
                    if (!className || className === 'ALL') return all;
                    return all.filter(s => s.className === className);
                },
                add: (sched) => {
                    const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
                    DB.set(STORAGE.SCHEDULES, [sched, ...all]);
                    if(isConnected()) setDoc(getDocRef('schedules', sched.id), sched).catch(console.error);
                },
                update: (updatedSched) => {
                    const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
                    const index = all.findIndex(s => s.id === updatedSched.id);
                    if (index !== -1) {
                        all[index] = updatedSched;
                        DB.set(STORAGE.SCHEDULES, all);
                        if(isConnected()) setDoc(getDocRef('schedules', updatedSched.id), updatedSched).catch(console.error);
                        return true;
                    }
                    return false;
                },
                delete: (id) => {
                    const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
                    DB.set(STORAGE.SCHEDULES, all.filter(s => s.id !== id));
                    if(isConnected()) deleteDoc(getDocRef('schedules', id)).catch(console.error);
                }
            }
        };

        // --- DATA CONSTANTS ---
        const MOCK_VERSES = [
            "Amsal 1:7 - Takut akan TUHAN adalah permulaan pengetahuan.",
            "Filipi 4:13 - Segala perkara dapat kutanggung di dalam Dia.",
            "Yosua 1:9 - Bukankah telah Kuperintahkan kepadamu: kuatkan dan teguhkanlah hatimu?",
            "Yeremia 29:11 - Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu."
        ];
        const ML_HEROES = [ "Alucard", "Miya", "Layla", "Zilong", "Tigreal", "Nana", "Eudora", "Gord", "Saber", "Balmond", "Akai", "Franco", "Chou", "Gusion", "Fanny", "Lesley" ];
        const JACOB_SONS = [ "Ruben", "Simeon", "Lewi", "Yehuda", "Dan", "Naftali", "Gad", "Asyer", "Isakhar", "Zebulon", "Yusuf", "Benyamin" ];
        const UserRole = { ADMIN: 'ADMIN', TEACHER: 'TEACHER', STUDENT: 'STUDENT' };
        const STORAGE = { USERS: 'gkps_users_v3', ATTENDANCE: 'gkps_att_v3', CLASSES: 'gkps_cls_v3', SESSION: 'gkps_sess_v3', MATERIALS: 'gkps_mat_v3', ACTIVITIES: 'gkps_act_v3', NOTIFICATIONS: 'gkps_notif_v3', SCHEDULES: 'gkps_sched_v3' };
        
        const DEFAULT_USERS = [
            { id: '1', name: 'Admin Utama', role: 'ADMIN', qrCode: 'ADMIN-001', gender: 'Laki-Laki', pin: 'admin123', isActive: true, lastLogin: new Date().toISOString() },
            { id: '2', name: 'Guru Sekolah Minggu', role: 'TEACHER', className: 'Kelas Daud', qrCode: 'GURU-001', gender: 'Perempuan', pin: '123456', isActive: true },
            { id: '3', name: 'Timothy Simanjuntak', role: 'STUDENT', className: 'Kelas Daud', qrCode: 'S-001', gender: 'Laki-Laki', pin: '123456', isActive: true },
            { id: '4', name: 'Sarah Damanik', role: 'STUDENT', className: 'Kelas Ester', qrCode: 'S-002', gender: 'Perempuan', pin: '123456', isActive: true },
        ];
        const DEFAULT_CLASSES = [
            { id: 'c1', name: 'Kelas Daud', desc: '4-6 Tahun' }, { id: 'c2', name: 'Kelas Daniel', desc: '7-9 Tahun' },
            { id: 'c3', name: 'Kelas Paulus', desc: '10-12 Tahun' }, { id: 'c4', name: 'Kelas Ester', desc: '13+ Tahun' }
        ];
        const DEFAULT_SCHEDULES = [
            { id: 's1', className: 'Kelas Daud', date: getLocalDate(), time: '08:00 - 09:30', activity: 'Ibadah Minggu', theme: 'Tuhan Yesus Baik', speaker: 'Kak Lisa', location: 'R. Daud Lt. 1', status: 'upcoming' },
            { id: 's2', className: 'Kelas Daniel', date: getLocalDate(), time: '08:00 - 09:30', activity: 'Ibadah & Aktivitas', theme: 'Daud Melawan Goliat', speaker: 'Kak Budi', location: 'R. Daniel Lt. 1', status: 'upcoming' },
        ];

        // --- GEMINI AI SERVICE ---
        const GeminiService = {
            call: async (prompt) => {
                const apiKey = ""; // API Key
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const delays = [1000, 2000, 4000];
                for (let i = 0; i <= 3; i++) {
                    try {
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                    } catch (error) {
                        if (i === 3) throw error;
                        await new Promise(resolve => setTimeout(resolve, delays[i]));
                    }
                }
            }
        };

        // --- COMPONENTS ---
        const Background = () => (
            <div className="fixed inset-0 overflow-hidden pointer-events-none -z-10 bg-[#f3f4f6]">
                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-50/50 via-purple-50/50 to-pink-50/50"></div>
                <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
                <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
                <div className="absolute -bottom-32 left-20 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '' }) => {
            const styles = {
                primary: "bg-gradient-to-r from-indigo-600 to-pink-500 text-white shadow-lg shadow-indigo-500/30 border-0",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
                glass: "bg-white/40 backdrop-blur-md border border-white/60 text-indigo-700 hover:bg-white/60",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100"
            };
            return <button onClick={onClick} className={`w-full py-4 rounded-2xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 ${styles[variant]} ${className}`}>{children}</button>;
        };

        const Avatar = ({ name, seed, style = 'avataaars', size = 'md', className='', onClick }) => {
            const s = size === 'lg' ? 'w-16 h-16 text-2xl' : size === 'xl' ? 'w-24 h-24 text-4xl' : 'w-10 h-10 text-sm';
            const avatarSeed = seed || name;
            const src = `https://api.dicebear.com/7.x/${style}/svg?seed=${avatarSeed}&backgroundColor=transparent`;
            return (
                <div onClick={onClick} className={`${s} rounded-full bg-gradient-to-tr from-indigo-400 to-pink-400 p-0.5 shadow-lg ${className} ${onClick ? 'cursor-pointer hover:scale-105 transition-transform' : ''}`}>
                    <div className="w-full h-full bg-white rounded-full flex items-center justify-center overflow-hidden">
                        <img src={src} alt={name} className="w-full h-full object-cover" onError={(e) => {e.target.src = `https://api.dicebear.com/7.x/initials/svg?seed=${name}`}} />
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 relative overflow-hidden">
                <Background />
                <div className="glass-panel p-8 rounded-3xl flex flex-col items-center gap-4 animate-pop">
                    <div className="loader"></div>
                    <p className="text-slate-600 font-bold text-sm">Menghubungkan Database...</p>
                </div>
            </div>
        );

        const formatDateIndo = (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        const isNotifVisible = (notif) => {
            return !notif.scheduledTime || new Date(notif.scheduledTime) <= new Date();
        };

        // --- COMPONENTS: Login, Dashboard, etc. ---
        
        const LoginScreen = ({ onLogin }) => {
            const [mode, setMode] = useState('TEACHER');
            const [users, setUsers] = useState([]);
            const [selected, setSelected] = useState('');
            const [pw, setPw] = useState('');
            const [secretCount, setSecretCount] = useState(0);
            const [showAdmin, setShowAdmin] = useState(false);
            const [showForgot, setShowForgot] = useState(false);
            const [recoveryKey, setRecoveryKey] = useState('');
            const [isSyncing, setIsSyncing] = useState(false);

            useEffect(() => setUsers(DB.get(STORAGE.USERS, DEFAULT_USERS)), []);

            const handleSecretTrigger = () => {
                if(showAdmin) return;
                const c = secretCount + 1;
                setSecretCount(c);
                if(c >= 5) { setShowAdmin(true); setMode('ADMIN'); alert("ðŸ”“ Admin Mode Terbuka!"); }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if(mode === 'ADMIN') {
                    if(pw === 'admin123') {
                        onLogin({ id: 'admin', name: 'Administrator', role: 'ADMIN', lastLogin: new Date().toISOString() });
                    } else alert('Password salah!');
                } else {
                    const u = users.find(x => x.id === selected);
                    if(u) {
                        if(u.isActive === false) return alert("Akun dinonaktifkan.");
                        if(u.pin === pw) onLogin(u);
                        else alert('PIN Salah (Default: 123456)');
                    } else alert('Pilih user dulu.');
                }
            };

            const handleManualSync = async () => {
                setIsSyncing(true);
                try {
                    const count = await syncFromFirestore();
                    if(count >= 0) {
                        setUsers(DB.get(STORAGE.USERS, DEFAULT_USERS));
                        alert(`Data diupdate: ${count} items.`);
                    } else alert("Gagal koneksi server.");
                } catch(e) {
                    alert("Gagal: " + e.message);
                } finally { setIsSyncing(false); }
            };

            const modes = showAdmin ? ['TEACHER', 'STUDENT', 'ADMIN'] : ['TEACHER', 'STUDENT'];
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <Background />
                    <div className="glass-panel p-8 rounded-[2.5rem] w-full max-w-sm animate-slide-up relative z-10">
                        <div className="flex justify-center mb-6">
                            <button onClick={handleSecretTrigger} className="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-pink-500 rounded-3xl flex items-center justify-center shadow-xl shadow-indigo-500/20 animate-float active:scale-90 transition-transform"><Church className="text-white w-10 h-10" /></button>
                        </div>
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-extrabold text-slate-800 tracking-tight mb-2 leading-tight">Presensi ASM-GSM<br/>GKPS Tangerang</h1>
                            <p className="text-slate-500 font-medium flex items-center justify-center gap-1"><Cloud size={14}/> Online Database System</p>
                        </div>
                        <div className="bg-white/50 p-1.5 rounded-2xl flex mb-6 backdrop-blur-sm">
                            {modes.map(m => (
                                <button key={m} onClick={() => { setMode(m); setSelected(''); setPw(''); }} className={`flex-1 py-3 text-[10px] font-bold rounded-xl transition-all ${mode === m ? 'bg-white text-indigo-600 shadow-md scale-100' : 'text-slate-400 hover:text-slate-600'}`}>{m === 'TEACHER' ? 'GURU' : m === 'STUDENT' ? 'SISWA' : 'ADMIN'}</button>
                            ))}
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            {mode !== 'ADMIN' ? (
                                <div className="space-y-3">
                                    <div className="relative group">
                                        <select value={selected} onChange={e => setSelected(e.target.value)} className="w-full p-4 pl-5 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-slate-700 appearance-none shadow-sm transition-all hover:border-indigo-300">
                                            <option value="">Pilih Nama Anda...</option>
                                            {users.filter(u => u.role === mode && u.isActive !== false).map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                        </select>
                                        <div className="absolute right-5 top-4 pointer-events-none text-slate-400"><ChevronRight className="rotate-90"/></div>
                                    </div>
                                    <input type="password" placeholder="PIN (Default: 123456)" value={pw} onChange={e => setPw(e.target.value)} className="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-slate-700 shadow-sm" />
                                </div>
                            ) : (
                                <div>
                                    <input type="password" placeholder="Password Admin" value={pw} onChange={e => setPw(e.target.value)} className="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-slate-700 shadow-sm" />
                                </div>
                            )}
                            <Button variant="primary">Masuk Aplikasi <Sparkles size={18} /></Button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={handleManualSync} disabled={isSyncing} className="text-xs font-bold text-indigo-500 bg-indigo-50 px-4 py-2 rounded-xl flex items-center gap-2 mx-auto active:scale-95 transition-transform">
                                {isSyncing ? <RefreshCw size={14} className="animate-spin"/> : <Cloud size={14}/>}
                                {isSyncing ? 'Mengupdate...' : 'Paksa Update Data'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const UserManagement = () => {
            const [users, setUsers] = useState([]);
            const [search, setSearch] = useState('');
            const [form, setForm] = useState({ name: '', role: 'STUDENT', className: 'Kelas Daud', gender: 'Laki-Laki', pin: '123456' });
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);
            
            useEffect(() => { setUsers(DB.get(STORAGE.USERS, DEFAULT_USERS)); }, []);

            const handleSubmit = () => {
                if(!form.name) return;
                const u = editingId ? { ...form, id: editingId, ...users.find(x=>x.id===editingId), ...form } : { ...form, id: Date.now().toString(), qrCode: `${form.role[0]}-${Date.now()}`, isActive: true, avatarStyle: 'avataaars' };
                editingId ? DB.users.update(u) : DB.users.add(u);
                setUsers(DB.get(STORAGE.USERS));
                setIsFormOpen(false); setEditingId(null); setForm({ name: '', role: 'STUDENT', className: 'Kelas Daud', gender: 'Laki-Laki', pin: '123456' });
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n');
                    let count = 0;
                    lines.forEach(line => {
                        const [name, role, className, gender] = line.split(',').map(s=>s?.trim());
                        if(name && role) {
                            const u = { id: Date.now().toString()+count, name, role: role.toUpperCase(), className: className||'-', gender: gender||'Laki-Laki', pin:'123456', isActive:true, qrCode: `CSV-${Date.now()}-${count}` };
                            DB.users.add(u);
                            count++;
                        }
                    });
                    setUsers(DB.get(STORAGE.USERS));
                    alert(`Import ${count} user berhasil.`);
                };
                reader.readAsText(file);
            };

            const filtered = users.filter(u => u.name.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="p-6 pb-32 animate-slide-up">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-extrabold text-slate-800">Manajemen User</h2>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                            <button onClick={()=>fileInputRef.current.click()} className="bg-emerald-50 text-emerald-600 p-2 rounded-xl text-xs font-bold flex gap-1 items-center"><Upload size={14}/> Import CSV</button>
                            <button onClick={() => setIsFormOpen(!isFormOpen)} className="bg-white p-2 rounded-xl text-indigo-600 shadow-sm"><Plus size={20}/></button>
                        </div>
                    </div>
                    {isFormOpen && (
                        <div className="glass-card p-5 rounded-[2rem] mb-6 animate-pop">
                            <input value={form.name} onChange={e=>setForm({...form, name: e.target.value})} placeholder="Nama" className="w-full p-3 rounded-xl bg-white/50 border mb-2"/>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                                <select value={form.role} onChange={e=>setForm({...form, role: e.target.value})} className="p-3 rounded-xl bg-white/50 border"><option value="STUDENT">Siswa</option><option value="TEACHER">Guru</option><option value="ADMIN">Admin</option></select>
                                <select value={form.gender} onChange={e=>setForm({...form, gender: e.target.value})} className="p-3 rounded-xl bg-white/50 border"><option value="Laki-Laki">Laki</option><option value="Perempuan">Perempuan</option></select>
                            </div>
                            <Button onClick={handleSubmit}>Simpan</Button>
                        </div>
                    )}
                    <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cari..." className="w-full p-3 rounded-2xl bg-white/60 mb-6 border-none outline-none"/>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {filtered.map(u => (
                            <div key={u.id} className="glass-card p-4 rounded-2xl flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <Avatar name={u.name} size="sm"/>
                                    <div><p className="font-bold text-sm">{u.name}</p><span className="text-xs text-slate-500">{u.role}</span></div>
                                </div>
                                <div className="flex gap-1">
                                    <button onClick={()=>{setForm(u); setEditingId(u.id); setIsFormOpen(true);}} className="bg-blue-50 text-blue-500 p-2 rounded-full"><Edit size={14}/></button>
                                    <button onClick={()=>{ if(confirm('Hapus?')) { DB.users.delete(u.id); setUsers(DB.get(STORAGE.USERS)); }}} className="text-red-500 bg-red-50 p-2 rounded-full"><Trash2 size={14}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user }) => {
            const [date, setDate] = useState(getLocalDate());
            const [att, setAtt] = useState([]);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [users, setUsers] = useState([]);
            const [schedules, setSchedules] = useState([]);
            
            // REALTIME SYNC LOGIC
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                // Load initial local data
                setAtt(DB.get(STORAGE.ATTENDANCE, []).filter(r => r.date === date));
                setUsers(DB.get(STORAGE.USERS, DEFAULT_USERS));

                // Listen to Firestore updates
                if (auth) {
                    const unsubAtt = onSnapshot(getCollectionRef('attendance'), (snap) => {
                        const data = snap.docs.map(d => d.data());
                        if(data.length > 0) {
                            localStorage.setItem(STORAGE.ATTENDANCE, JSON.stringify(data));
                            setAtt(data.filter(r => r.date === date));
                        }
                    });
                    const unsubUsers = onSnapshot(getCollectionRef('users'), (snap) => {
                        const data = snap.docs.map(d => d.data());
                        if(data.length > 0) {
                            localStorage.setItem(STORAGE.USERS, JSON.stringify(data));
                            setUsers(data);
                        }
                    });
                    return () => { unsubAtt(); unsubUsers(); };
                }

                return () => { window.removeEventListener('online', handleOnline); window.removeEventListener('offline', handleOffline); };
            }, [date]);

            // Stats
            const stats = useMemo(() => {
                const g = {};
                att.filter(x=>x.role==='STUDENT').forEach(x => g[x.className] = (g[x.className]||0)+1);
                return Object.entries(g).map(([k,v]) => ({ name: k, value: v }));
            }, [att]);

            const COLORS = ['#6366f1', '#ec4899', '#a855f7', '#f43f5e'];

            const handleExport = () => {
                if(att.length === 0) return alert("Tidak ada data");
                const ws = XLSX.utils.json_to_sheet(att.map(a => ({ Nama: a.userName, Kelas: a.className, Waktu: a.timestamp })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Absensi");
                XLSX.writeFile(wb, `Absensi_${date}.xlsx`);
            };

            return (
                <div className="p-6 pb-32 animate-slide-up">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${isOnline ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`}>
                                    {isOnline ? <><Wifi size={10}/> Online</> : <><WifiOff size={10}/> Offline</>}
                                </span>
                            </div>
                            <h2 className="text-3xl font-extrabold text-slate-800">Dashboard</h2>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleExport} className="bg-green-500 text-white p-2 rounded-xl"><FileSpreadsheet size={18}/></button>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 text-sm font-bold text-slate-600 outline-none" />
                        </div>
                    </header>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="glass-card p-5 rounded-3xl relative overflow-hidden">
                            <p className="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Total Hadir</p>
                            <h3 className="text-4xl font-extrabold text-indigo-600">{att.length}</h3>
                        </div>
                        <div className="glass-card p-5 rounded-3xl relative overflow-hidden">
                            <p className="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Kelas Top</p>
                            <h3 className="text-xl font-extrabold text-pink-600">{stats.sort((a,b)=>b.value-a.value)[0]?.name.replace('Kelas ','') || '-'}</h3>
                        </div>
                    </div>

                    <div className="glass-card p-6 rounded-[2rem] mb-6">
                        <h3 className="font-bold text-slate-700 mb-6">Sebaran Kelas</h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer>
                                <PieChart>
                                    <Pie data={stats} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                        {stats.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                    </Pie>
                                    <Tooltip />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    <div className="space-y-3">
                        <h3 className="font-bold text-slate-700">Baru Hadir</h3>
                        {att.map((r, i) => (
                            <div key={i} className="glass-card p-3 rounded-xl flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Avatar name={r.userName} size="sm"/>
                                    <div><p className="font-bold text-sm">{r.userName}</p><p className="text-xs text-slate-500">{r.className}</p></div>
                                </div>
                                <span className="text-xs font-bold text-indigo-500">{new Date(r.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                        ))}
                        {att.length === 0 && <div className="text-center text-slate-400 py-4">Belum ada data</div>}
                    </div>
                </div>
            );
        };

        const StudentDashboard = ({ user }) => {
            const [tab, setTab] = useState('card');
            const [history, setHistory] = useState([]);
            const [materials, setMaterials] = useState([]);
            const [schedules, setSchedules] = useState([]);
            
            // Listen realtime for student data
            useEffect(() => {
                if (auth) {
                    const unsubAtt = onSnapshot(getCollectionRef('attendance'), (snap) => {
                        const data = snap.docs.map(d => d.data());
                        setHistory(data.filter(a => a.userId === user.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)));
                    });
                    const unsubMat = onSnapshot(getCollectionRef('materials'), (snap) => {
                        const data = snap.docs.map(d => d.data());
                        setMaterials(data.filter(m => m.className === user.className));
                    });
                    return () => { unsubAtt(); unsubMat(); };
                } else {
                    setHistory(DB.get(STORAGE.ATTENDANCE, []).filter(a => a.userId === user.id));
                }
            }, [user]);

            const verse = materials.length > 0 ? materials[0].verse : MOCK_VERSES[0];
            const theme = materials.length > 0 ? materials[0].theme : "Sekolah Minggu GKPS";

            return (
                <div className="p-6 h-full flex flex-col pb-24 max-w-md mx-auto animate-slide-up">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">Halo, {user.name.split(' ')[0]}! ðŸ‘‹</h2>
                            <p className="text-xs text-slate-500 font-medium">{user.className}</p>
                        </div>
                    </div>
                    
                    <div className="flex bg-white/50 p-1 rounded-2xl mb-6 backdrop-blur-sm shadow-sm">
                        {['card', 'history', 'materials'].map(t => (
                            <button key={t} onClick={() => setTab(t)} className={`flex-1 py-2.5 text-[11px] font-bold rounded-xl transition-all ${tab === t ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-500'}`}>
                                {t === 'card' ? 'Kartu' : t === 'history' ? 'Riwayat' : 'Materi'}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        {tab === 'card' && (
                            <div className="relative w-full perspective group animate-pop">
                                <div className="relative bg-white/90 backdrop-blur-xl rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/50">
                                    <div className="h-32 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 p-6 relative">
                                        <div className="flex justify-between items-start relative z-10 text-white">
                                            <h1 className="font-extrabold tracking-tight">GKPS CARD</h1>
                                            <ShieldCheck size={24}/>
                                        </div>
                                    </div>
                                    <div className="px-6 pb-8 flex flex-col items-center -mt-16 relative z-10">
                                        <Avatar name={user.name} seed={user.avatarSeed} style={user.avatarStyle} size="xl" className="border-4 border-white mb-4" />
                                        <h2 className="text-2xl font-black text-slate-800 text-center mb-1">{user.name}</h2>
                                        <span className="bg-indigo-50 text-indigo-600 px-4 py-1 rounded-full text-xs font-bold uppercase mb-6">{user.className}</span>
                                        <div className="p-4 bg-white rounded-3xl border-2 border-dashed border-slate-200 shadow-inner mb-4">
                                            <QRCode value={user.qrCode} size={160} />
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-6 border-t border-slate-100 text-center">
                                        <p className="text-xs font-bold text-indigo-600 uppercase mb-1">{theme}</p>
                                        <p className="text-sm font-medium text-slate-600 italic">"{verse}"</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'history' && (
                            <div className="space-y-4 animate-pop">
                                {history.map((h, i) => (
                                    <div key={h.id} className="glass-card p-4 rounded-2xl flex justify-between items-center border-l-4 border-l-emerald-500">
                                        <div>
                                            <p className="font-bold text-slate-800 text-sm">{formatDateIndo(h.date)}</p>
                                            <p className="text-xs text-slate-500">Hadir</p>
                                        </div>
                                        <span className="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold">{new Date(h.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {tab === 'materials' && (
                            <div className="space-y-4 animate-pop">
                                {materials.map((m, i) => (
                                    <div key={m.id} className="glass-card p-5 rounded-2xl">
                                        <h4 className="text-lg font-extrabold text-slate-800">{m.theme}</h4>
                                        <p className="text-xs text-slate-500 mb-2">{formatDateIndo(m.createdAt)}</p>
                                        <div className="bg-slate-50 p-3 rounded-xl border"><p className="text-sm italic">"{m.verse}"</p></div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Scanner = ({ user }) => {
            const [status, setStatus] = useState({ type: 'idle', msg: '' });
            const [manual, setManual] = useState(false);
            const [txt, setTxt] = useState('');
            
            const onScan = (code) => {
                if(status.type !== 'idle' || !code) return;
                const clean = code.trim();
                const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
                const u = users.find(x => x.qrCode === clean || x.id === clean || x.name.toLowerCase() === clean.toLowerCase());
                
                if(!u) setStatus({ type: 'err', msg: 'User Tidak Ditemukan' });
                else {
                    const res = DB.att.add({
                        id: Date.now(), userId: u.id, userName: u.name, className: u.className||'-', role: u.role,
                        date: getLocalDate(), timestamp: new Date().toISOString()
                    });
                    setStatus({ type: res.success ? 'ok' : 'err', msg: res.success ? `Berhasil: ${u.name}` : 'Sudah Absen' });
                }
                setTimeout(() => setStatus({type:'idle', msg:''}), 2000);
            };

            useEffect(() => {
                if(!manual) {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan).catch(err => console.log(err));
                    return () => { html5QrCode.stop().catch(err => console.log(err)); };
                }
            }, [manual]);

            return (
                <div className="p-6 pb-32 h-full flex flex-col items-center justify-center">
                    <h2 className="text-2xl font-bold mb-6 text-slate-800">Scanner</h2>
                    <div className="w-full max-w-sm aspect-square bg-black rounded-3xl overflow-hidden relative mb-6">
                        {manual ? (
                            <div className="w-full h-full flex flex-col items-center justify-center bg-slate-900 p-6">
                                <input value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Input ID/Nama" className="w-full p-4 rounded-xl text-black font-bold mb-4"/>
                                <Button onClick={()=>{onScan(txt); setTxt('');}}>Proses</Button>
                            </div>
                        ) : <div id="reader" className="w-full h-full"></div>}
                        
                        {status.type !== 'idle' && (
                            <div className={`absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm z-50`}>
                                <div className="text-center p-6 bg-white rounded-3xl animate-pop">
                                    <h3 className={`text-xl font-bold mb-2 ${status.type==='ok'?'text-green-600':'text-red-600'}`}>{status.type==='ok'?'SUKSES':'GAGAL'}</h3>
                                    <p className="font-bold text-slate-700">{status.msg}</p>
                                </div>
                            </div>
                        )}
                    </div>
                    <Button onClick={()=>setManual(!manual)} variant="secondary">{manual ? 'Gunakan Kamera' : 'Input Manual'}</Button>
                </div>
            );
        };

        const MainApp = ({ user, onLogout }) => {
            const nav = useNavigate();
            const loc = useLocation();
            const menus = [
                { path: '/', icon: LayoutDashboard, label: 'Home', roles: ['ADMIN', 'TEACHER'] },
                { path: '/scan', icon: QrCode, label: 'Scan', roles: ['ADMIN', 'TEACHER'] },
                { path: '/users', icon: Users, label: 'Users', roles: ['ADMIN'] },
                { path: '/', icon: CreditCard, label: 'Kartu', roles: ['STUDENT'] },
            ].filter(m => m.roles.includes(user.role));

            return (
                <div className="h-screen flex flex-col md:max-w-md mx-auto bg-white/30 shadow-2xl relative overflow-hidden">
                    <div className="flex-1 overflow-y-auto">
                        <Routes>
                            <Route path="/" element={user.role === 'STUDENT' ? <StudentDashboard user={user}/> : <Dashboard user={user} />} />
                            <Route path="/scan" element={<Scanner user={user} />} />
                            <Route path="/users" element={<UserManagement />} />
                        </Routes>
                    </div>
                    {user.role !== 'STUDENT' && (
                        <div className="absolute bottom-6 left-6 right-6 glass-nav rounded-2xl p-2 flex justify-between shadow-xl z-50">
                            {menus.map((m, i) => {
                                const active = loc.pathname === m.path;
                                return (
                                    <button key={i} onClick={() => nav(m.path)} className={`flex-1 h-12 rounded-xl flex items-center justify-center transition-all ${active ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-white/50'}`}>
                                        <m.icon size={24} />
                                    </button>
                                );
                            })}
                            <button onClick={onLogout} className="flex-1 h-12 rounded-xl flex items-center justify-center text-red-400 hover:bg-red-50"><LogOut size={24}/></button>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const init = async () => {
                    try {
                        if(auth) {
                            await signInAnonymously(auth);
                            // Initial Sync
                            await syncFromFirestore();
                        }
                    } catch(e) { console.error(e); }
                    
                    const sess = DB.get(STORAGE.SESSION);
                    if(sess) setUser(sess);
                    setLoading(false);
                };
                init();
            }, []);

            const login = (u) => { setUser(u); DB.set(STORAGE.SESSION, u); };
            const logout = () => { setUser(null); localStorage.removeItem(STORAGE.SESSION); };

            if(loading) return <LoadingScreen />;
            if(!user) return <LoginScreen onLogin={login} />;
            return <HashRouter><MainApp user={user} onLogout={logout} /></HashRouter>;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
