<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance GKPS Tangerang - Picasso Cubism Style</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap');

        /* =========================================
           === GLOBAL PICASSO CUBISM THEME ===
           ========================================= */
        
        :root {
            --picasso-blue: #1e3a8a; /* Biru Kobalt Gelap */
            --picasso-yellow: #fbbf24; /* Kuning Oker */
            --picasso-red: #b91c1c; /* Merah Bata */
            --picasso-orange: #ea580c; /* Oranye Terbakar */
            --picasso-cream: #fef3c7; /* Putih Tulang */
            --picasso-black: #18181b; /* Hitam Arang */
        }

        body { 
            font-family: 'Space Mono', monospace;
            color: var(--picasso-black);
            background-color: var(--picasso-cream);
            /* Latar belakang geometris abstrak */
            background-image: 
                linear-gradient(45deg, var(--picasso-blue) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--picasso-yellow) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--picasso-red) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--picasso-orange) 75%);
            background-size: 100px 100px;
            background-position: 0 0, 0 50px, 50px -50px, -50px 0px;
            min-height: 100vh;
            padding-bottom: 3rem;
            overflow-x: hidden;
        }

        /* --- Typography --- */
        h1, h2, h3, .picasso-title {
            font-family: 'Bebas Neue', cursive;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        /* Efek teks bergeser (glitch/cubist) */
        .picasso-glitch-text {
            position: relative; display: inline-block;
            color: var(--picasso-black);
        }
        .picasso-glitch-text::before, .picasso-glitch-text::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; opacity: 0.8; z-index: -1;
        }
        .picasso-glitch-text::before { color: var(--picasso-blue); transform: translate(-4px, 4px); }
        .picasso-glitch-text::after { color: var(--picasso-red); transform: translate(4px, -2px); }

        /* --- Main Container Card (The Canvas Shard) --- */
        .picasso-card {
            background-color: white;
            border: 4px solid var(--picasso-black);
            /* Bentuk poligon asimetris "pecahan kaca" */
            clip-path: polygon(2% 0%, 98% 2%, 100% 95%, 0% 100%);
            padding: 3rem 2.5rem; position: relative;
            box-shadow: 15px 15px 0px var(--picasso-black); /* Bayangan keras dan datar */
            transition: all 0.3s ease;
        }
        /* Elemen dekoratif latar belakang kartu */
        .picasso-card::before {
            content: ''; position: absolute; top: -20px; left: -20px; width: 50%; height: 50%;
            background: var(--picasso-yellow); z-index: -1; transform: rotate(-10deg); border: 3px solid var(--picasso-black);
        }
        .picasso-card::after {
            content: ''; position: absolute; bottom: -20px; right: -20px; width: 40%; height: 60%;
            background: var(--picasso-blue); z-index: -2; transform: rotate(5deg); border: 3px solid var(--picasso-black);
        }

        /* --- Navigation (Geometric Blocks) --- */
        .picasso-nav-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            padding: 1rem; background: var(--picasso-black);
            transform: skewY(-2deg); border-bottom: 5px solid var(--picasso-red);
        }
        .nav-btn {
            font-family: 'Bebas Neue', cursive; font-size: 1.2rem; padding: 0.8rem 1.5rem;
            background: white; color: var(--picasso-black); border: 3px solid var(--picasso-black);
            /* Bentuk tombol yang tidak beraturan */
            clip-path: polygon(5% 0%, 100% 0%, 95% 100%, 0% 100%);
            transition: all 0.2s; transform: skewX(-10deg);
        }
        .nav-btn.active {
            background: var(--picasso-yellow); color: var(--picasso-black);
            transform: skewX(-10deg) translateY(-5px);
            box-shadow: 5px 5px 0px var(--picasso-red);
        }
        .nav-btn.inactive:hover { background: var(--picasso-blue); color: white; transform: skewX(-10deg) translateY(-3px); }

        /* --- Buttons & Inputs (Constructivist Style) --- */
        .picasso-btn {
            font-family: 'Bebas Neue', cursive; font-size: 1.4rem;
            background: var(--picasso-red); color: white; border: 4px solid var(--picasso-black);
            padding: 1rem 2rem; cursor: pointer; transition: all 0.2s;
            /* Bentuk tombol asimetris */
            clip-path: polygon(0 0, 100% 5%, 98% 100%, 2% 95%);
        }
        .picasso-btn:hover { background: var(--picasso-orange); transform: scale(1.05) rotate(2deg); box-shadow: 8px 8px 0px var(--picasso-black); }

        .picasso-input, .picasso-select {
            width: 100%; padding: 1rem; border: 4px solid var(--picasso-black);
            font-family: 'Space Mono', monospace; font-weight: 700;
            background: white; outline: none; transition: all 0.2s;
            /* Input sedikit miring */
            transform: skewX(-5deg);
        }
        .picasso-input:focus, .picasso-select:focus {
            border-color: var(--picasso-blue); background: var(--picasso-cream);
            transform: skewX(-5deg) translate(-4px, -4px); box-shadow: 6px 6px 0px var(--picasso-black);
        }

        /* --- Avatars (Polygon Style) --- */
        .picasso-avatar {
            width: 60px; height: 60px; object-fit: cover;
            border: 3px solid var(--picasso-black);
            /* Bentuk heksagon/poligon tidak beraturan */
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            filter: contrast(1.2) saturate(1.5); /* Warna lebih tajam */
            transition: all 0.3s; cursor: pointer; background: white;
        }
        .picasso-avatar:hover, .picasso-avatar.selected {
            transform: scale(1.2) rotate(10deg);
            filter: contrast(1.3) saturate(2) drop-shadow(5px 5px 0px var(--picasso-yellow));
            z-index: 10;
        }

        /* --- ID Card Preview (Cubist Collage) --- */
        .picasso-id-card-container {
            position: relative; width: 320px; height: 480px;
            perspective: 1000px;
        }
        .picasso-id-card {
            width: 100%; height: 100%;
            background: white; border: 5px solid var(--picasso-black);
            padding: 2rem; text-align: center; position: relative; overflow: hidden;
            /* Rotasi 3D agar terlihat seperti potongan kertas melayang */
            transform: rotateY(-10deg) rotateX(5deg);
            box-shadow: 20px 20px 0px rgba(0,0,0,0.2);
        }
        /* Layer kolase di belakang ID card */
        .picasso-id-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 40%; background: var(--picasso-blue); clip-path: polygon(0 0, 100% 0, 100% 80%, 0 100%); z-index: -1; }
        .picasso-id-card::after { content: ''; position: absolute; bottom: 0; right: 0; width: 70%; height: 50%; background: var(--picasso-red); clip-path: polygon(20% 0, 100% 20%, 100% 100%, 0 100%); z-index: -1; }

        .avatar-polygon-large {
            width: 130px; height: 130px; margin: 0 auto 1rem;
            clip-path: polygon(50% 0%, 100% 25%, 85% 100%, 15% 100%, 0% 25%);
            background: var(--picasso-yellow); padding: 5px; border: 4px solid var(--picasso-black);
            transform: rotate(-5deg);
        }
        
        /* --- Abstract Icons --- */
        .abstract-icon {
            width: 50px; height: 50px; background: var(--picasso-black);
            display: flex; align-items: center; justify-content: center; color: var(--picasso-yellow);
            clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 85% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 85% 100%, 15% 100%, 15% 85%, 0% 85%);
            transform: rotate(45deg); border: 2px solid white;
        }
        .abstract-icon svg { transform: rotate(-45deg); }

        /* --- Admin Table (Constructivist Grid) --- */
        .picasso-table-container {
            border: 5px solid var(--picasso-black); background: white;
            box-shadow: 10px 10px 0px var(--picasso-blue);
            transform: skewX(-2deg);
        }
        .picasso-table thead th {
            font-family: 'Bebas Neue'; font-size: 1.3rem; letter-spacing: 1px;
            background: var(--picasso-black); color: white; padding: 1rem;
            border-right: 3px solid white;
        }
        .picasso-table tbody tr { border-bottom: 4px solid var(--picasso-black); }
        .picasso-table tbody td {
            padding: 1rem; font-weight: bold; border-right: 3px solid var(--picasso-black);
        }
        .picasso-table tbody tr:hover { background: var(--picasso-yellow); color: var(--picasso-black) !important;}
        
        /* Scanner Frame (Broken Viewfinder) */
        .scanner-frame {
            border: 8px dashed var(--picasso-black); padding: 10px; background: var(--picasso-red);
            clip-path: polygon(0 0, 100% 5%, 95% 100%, 5% 95%); transform: rotate(2deg);
        }
        #reader { border: 4px solid white; filter: grayscale(1) contrast(1.5); }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto relative">
        <header class="text-center mb-12 relative z-10">
            <div class="absolute inset-0 bg-yellow-400 transform -skew-y-3 scale-110 z-[-1] border-4 border-black clip-path-polygon(0 0, 100% 10%, 95% 100%, 5% 90%)"></div>
            <h1 class="text-6xl md:text-7xl font-extrabold mb-2 text-black picasso-glitch-text" data-text="GKPS TANGERANG">GKPS TANGERANG</h1>
            <p class="font-bold text-xl bg-black text-white inline-block px-4 py-1 transform skew-x-[-10deg]">Sistem Absensi Sekolah Minggu</p>
        </header>

        <nav class="picasso-nav-container mb-16 max-w-fit mx-auto relative z-20">
            <button onclick="switchNav('home')" id="nav-home" class="nav-btn active">Beranda</button>
            <button onclick="switchNav('register')" id="nav-register" class="nav-btn inactive">Pendaftaran</button>
            <button onclick="switchNav('scan')" id="nav-scan" class="nav-btn inactive">Scan Barcode</button>
            <button onclick="switchNav('admin')" id="nav-admin" class="nav-btn inactive">Data Absensi</button>
        </nav>

        <section id="home" class="section">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div class="picasso-card flex flex-col items-center text-center transform rotate-[-2deg]">
                    <div class="abstract-icon mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h2 class="picasso-title text-4xl mb-4 bg-blue-900 text-white px-4 py-1 transform skew-x-[-5deg]">Selamat Hari Minggu!</h2>
                    <p class="text-lg font-bold mb-4 leading-relaxed">"Biarkan bentuk dan warna memuji Tuhan. Siapkan barcodemu!"</p>
                    <div class="w-full h-4 bg-black my-4 clip-path-polygon(0 0, 100% 20%, 95% 100%, 5% 80%)"></div>
                </div>

                <div class="picasso-card transform rotate-[3deg] relative" style="z-index: 5;">
                    <h3 class="picasso-title text-3xl text-center mb-6 border-b-4 border-black inline-block mx-auto">Statistik Kubisme</h3>
                    
                    <div class="flex flex-col items-center mb-8">
                        <span class="picasso-title" style="font-size: 7rem; line-height: 1; color: var(--picasso-red); text-shadow: 5px 5px 0px var(--picasso-black); transform: skewX(-10deg);" id="stat-count">0</span>
                        <span class="font-bold text-xl bg-yellow-400 px-3 border-2 border-black transform skew-x-[-5deg]">Jiwa Hadir</span>
                    </div>

                    <div class="pt-6 border-t-4 border-dashed border-black">
                        <p class="font-bold mb-4 flex items-center justify-center uppercase tracking-widest bg-black text-white py-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            Wajah Hari Ini
                        </p>
                        <div class="flex flex-wrap gap-3 justify-center" id="today-avatars-list">
                            <span class="font-bold italic opacity-60 bg-white p-2 border-2 border-black">Belum ada fragmen wajah...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="register" class="section hidden">
            <div class="grid md:grid-cols-2 gap-12 items-start">
                <div class="picasso-card transform rotate-[1deg]">
                    <h2 class="picasso-title text-4xl mb-8 bg-red-700 text-white inline-block px-6 py-2 transform skew-x-[-10deg] border-4 border-black">Registrasi Baru</h2>
                    <div class="space-y-8">
                        <div>
                            <label class="block text-xl font-bold mb-2 uppercase bg-black text-white inline-block px-2 transform skew-x-[-5deg]">Nama Lengkap</label>
                            <input type="text" id="reg-name" class="picasso-input" placeholder="Contoh: Felicia Damanik">
                        </div>
                        <div>
                            <label class="block text-xl font-bold mb-2 uppercase bg-blue-900 text-white inline-block px-2 transform skew-x-[-5deg]">Peran</label>
                            <select id="reg-role" class="picasso-select">
                                <option value="Anak">Anak Sekolah Minggu</option>
                                <option value="Guru">Guru Sekolah Minggu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xl font-bold mb-3 uppercase bg-yellow-400 text-black border-2 border-black inline-block px-2 transform skew-x-[-5deg]">Pilih Avatar Kubis</label>
                            <div class="flex gap-4 mt-2 overflow-x-auto pb-4 p-4 bg-white border-4 border-black justify-start transform skew-x-[-2deg]" id="avatar-list">
                                </div>
                        </div>
                        <button onclick="registerUser()" class="picasso-btn w-full">Konstruksi ID Card</button>
                    </div>
                </div>
                
                <div id="id-card-result" class="flex flex-col items-center justify-center hidden">
                     <h3 class="picasso-title text-3xl mb-6 bg-black text-white px-4 py-1 transform rotate-[-2deg]">Pratinjau Kolase ID</h3>
                    
                     <div class="picasso-id-card-container">
                        <div class="picasso-id-card flex flex-col items-center">
                            <div class="text-xl font-bold tracking-widest mb-4 picasso-title bg-yellow-400 px-4 border-2 border-black transform skew-x-[-10deg]">GKPS TANGERANG</div>
                            
                            <div class="avatar-polygon-large mb-4 relative z-10">
                                <img id="card-avatar" src="" alt="Avatar" class="w-full h-full object-cover clip-path-polygon(50% 0%, 100% 25%, 85% 100%, 15% 100%, 0% 25%) filter contrast(1.2)">
                            </div>
                            
                            <h2 id="card-name" class="text-4xl font-extrabold uppercase leading-none mb-2 picasso-title text-black bg-white border-2 border-black px-2 transform rotate-[-3deg] relative z-10">Nama Peserta</h2>
                            <p id="card-role" class="text-white bg-red-700 font-bold mb-auto text-2xl uppercase px-4 py-1 border-2 border-black transform skew-x-[-10deg] relative z-10">ROLE</p>
                            
                            <div class="bg-white p-2 mt-6 w-full border-4 border-black transform rotate-[2deg] relative z-10">
                                <svg id="barcode" class="w-full"></svg>
                            </div>
                        </div>
                    </div>
                    <button onclick="window.print()" class="mt-10 picasso-btn flex items-center px-8 bg-blue-900 hover:bg-blue-800">
                        Cetak Karya Ini
                    </button>
                </div>
            </div>
        </section>

        <section id="scan" class="section hidden">
            <div class="grid md:grid-cols-2 gap-10">
                <div class="picasso-card transform rotate-[-1deg]">
                    <h2 class="picasso-title text-3xl mb-6 text-center bg-black text-white py-2 border-4 border-yellow-400 transform skew-x-[-5deg]">Pemindai Wajah & Kode</h2>
                    
                    <div class="scanner-frame">
                        <div id="reader"></div>
                    </div>

                    <div id="scan-result" class="mt-6 text-center p-4 font-bold text-lg border-4 border-black bg-white transform skew-x-[-2deg] hidden shadow-[8px_8px_0px_black]"></div>
                </div>

                 <div class="picasso-card transform rotate-[2deg]">
                    <h3 class="picasso-title text-2xl mb-6 text-center border-b-4 border-black pb-2 inline-block mx-auto bg-yellow-400 px-4">Catatan Fragmen Terkini</h3>
                    <div class="overflow-y-auto max-h-[400px] pr-2 border-4 border-black bg-white p-2">
                         <table class="w-full text-left">
                            <tbody id="recent-scan-table" class="divide-y-4 divide-black">
                                <tr><td class="text-black italic py-4 text-center font-bold bg-gray-100">Belum ada fragmen hari ini.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="admin" class="section hidden">
            <div class="picasso-card transform rotate-[1deg]">
                <div class="flex flex-wrap justify-between items-end mb-10 pt-4">
                    <div>
                        <h2 class="picasso-title text-5xl bg-black text-white px-6 py-2 inline-block transform skew-x-[-10deg] border-r-8 border-yellow-400">Grid Data Kehadiran</h2>
                    </div>
                    <button onclick="exportData()" class="mt-6 md:mt-0 picasso-btn flex items-center text-xl px-6 py-3 bg-green-600 hover:bg-green-700 clip-path-polygon(5% 0, 100% 0, 95% 100%, 0% 100%)">
                        Ekspor CSV
                    </button>
                </div>
                
                <div class="picasso-table-container overflow-x-auto">
                    <table class="w-full text-left picasso-table">
                        <thead>
                            <tr>
                                <th class="py-4 px-6">Subjek</th>
                                <th class="py-4 px-6">Kategori</th>
                                <th class="py-4 px-6">Dimensi Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body" class="bg-white">
                            </tbody>
                    </table>
                </div>

                <div class="mt-12 pt-6 border-t-8 border-black flex justify-end">
                    <button onclick="clearAttendance()" class="picasso-btn bg-red-800 hover:bg-red-900 text-lg flex items-center uppercase tracking-widest px-6 py-4 clip-path-polygon(10% 0, 100% 10%, 90% 100%, 0% 90%)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Dekonstruksi Semua Data
                    </button>
                </div>
            </div>
        </section>

    </div>

    <script>
        // Database Sederhana
        let users = JSON.parse(localStorage.getItem('gkps_users')) || [];
        let attendance = JSON.parse(localStorage.getItem('gkps_attendance')) || [];
        let selectedAvatar = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix';

        // Avatar Options (Updated to Picasso Polygon Style)
        const avatarSeeds = ['Felix', 'Aneka', 'Boo', 'Buddy', 'Cookie', 'Daisy', 'Tigger', 'Molly', 'Coco', 'Simba', 'Ginger'];
        const avatarListDiv = document.getElementById('avatar-list');
        avatarSeeds.forEach((seed, index) => {
            const url = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}`;
            const img = document.createElement('img');
            img.src = url;
            img.className = `picasso-avatar ${index === 0 ? 'selected' : ''}`;
            
            img.onclick = () => {
                selectedAvatar = url;
                document.querySelectorAll('#avatar-list img').forEach(i => i.classList.remove('selected'));
                img.classList.add('selected');
            };
            avatarListDiv.appendChild(img);
        });

        // Navigation Logic
        function switchNav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            });
            document.getElementById('nav-' + id).classList.remove('inactive');
            document.getElementById('nav-' + id).classList.add('active');

            if(id === 'admin') renderAttendance();
            if(id === 'home') updateStats();
            if(id === 'scan') {
                startScanner();
                renderRecentScansTable();
            } else {
                stopScanner();
            }
        }

        // Register Logic
        function registerUser() {
            const name = document.getElementById('reg-name').value;
            const role = document.getElementById('reg-role').value;
            if(!name) return alert('Mohon isi Nama Lengkap untuk memulai konstruksi.');

            const id = 'GKPS-' + Date.now();
            const newUser = { id, name, role, avatar: selectedAvatar };
            users.push(newUser);
            localStorage.setItem('gkps_users', JSON.stringify(users));

            const resultSection = document.getElementById('id-card-result');
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });

            document.getElementById('card-name').innerText = name;
            document.getElementById('card-role').innerText = role;
            document.getElementById('card-avatar').src = selectedAvatar;
            
            // Barcode generation - bold and stark
            JsBarcode("#barcode", id, { format: "CODE128", width: 4, height: 80, displayValue: true, fontSize: 20, margin: 5, lineColor: "#18181b", background: "transparent", font: "Space Mono" });
            document.getElementById('reg-name').value = '';
        }

        // Scanner Logic
        let html5QrcodeScanner;
        function startScanner() {
            if(html5QrcodeScanner) return;
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 });
            html5QrcodeScanner.render((decodedText) => { processAttendance(decodedText); }, (errorMessage) => {});
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => { html5QrcodeScanner = null; }).catch(error => { console.error("Failed to clear scanner", error); });
            }
        }

        function processAttendance(barcodeId) {
            const user = users.find(u => u.id === barcodeId);
            const resultDiv = document.getElementById('scan-result');
            resultDiv.classList.remove('hidden');

            if(user) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = now.toLocaleDateString();

                const already = attendance.find(a => a.id === barcodeId && a.date === dateStr);
                if(already) {
                    // Picasso Warning Style
                    resultDiv.className = "mt-6 text-center p-4 border-4 border-black bg-yellow-400 text-black font-bold text-xl transform skew-x-[-5deg] shadow-[8px_8px_0px_var(--picasso-red)]";
                    resultDiv.innerHTML = `⚠️ SUBJEK <span class="picasso-title bg-black text-white px-2">${user.name}</span> SUDAH TERCATAT PUKUL ${already.time}.`;
                } else {
                    attendance.push({ id: barcodeId, name: user.name, role: user.role, time: timeStr, date: dateStr, avatar: user.avatar });
                    localStorage.setItem('gkps_attendance', JSON.stringify(attendance));
                    // Picasso Success Style
                    resultDiv.className = "mt-6 text-center p-4 border-4 border-black bg-blue-900 text-white font-bold text-xl transform skew-x-[-5deg] shadow-[8px_8px_0px_var(--picasso-yellow)]";
                    resultDiv.innerHTML = `✅ KONSTRUKSI BERHASIL. SELAMAT DATANG, <span class="picasso-title bg-yellow-400 text-black px-2">${user.name}</span>.`;
                    renderRecentScansTable();
                }
            } else {
                // Picasso Error Style
                resultDiv.className = "mt-6 text-center p-4 border-4 border-black bg-red-700 text-white font-bold text-xl transform skew-x-[-5deg] shadow-[8px_8px_0px_black]";
                resultDiv.innerHTML = `❌ KODE TIDAK DIKENALI DALAM STRUKTUR.`;
            }
             setTimeout(() => { resultDiv.classList.add('hidden'); }, 4000);
        }

        // Admin & Stats Logic (Updated for Picasso Grid)
        function renderAttendance() {
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = '';
            if(attendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-black font-bold bg-yellow-200 border-4 border-black m-4 transform rotate-1">GRID DATA MASIH KOSONG.</td></tr>';
                return;
            }
            attendance.slice().reverse().forEach(record => {
                tbody.innerHTML += `
                    <tr class="transition-all font-bold">
                        <td class="py-4 px-6 flex items-center border-r-4 border-black bg-white">
                             <img src="${record.avatar || 'https://api.dicebear.com/7.x/adventurer/svg?seed=default'}" class="w-12 h-12 border-2 border-black mr-4 clip-path-polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%) bg-yellow-400">
                            <span class="text-lg uppercase">${record.name}</span>
                        </td>
                        <td class="py-4 px-6 border-r-4 border-black bg-gray-50">
                            <span class="px-4 py-1 text-sm font-bold border-2 border-black transform skew-x-[-10deg] inline-block ${record.role === 'Guru' ? 'bg-blue-900 text-white' : 'bg-yellow-400 text-black'}">
                                ${record.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="py-4 px-6 text-black font-mono text-lg bg-white">${record.date} // ${record.time}</td>
                    </tr>
                `;
            });
        }

        function updateStats() {
            const today = new Date().toLocaleDateString();
            const todayAttendance = attendance.filter(a => a.date === today);
            document.getElementById('stat-count').innerText = todayAttendance.length;

            const avatarsContainer = document.getElementById('today-avatars-list');
            avatarsContainer.innerHTML = '';
            
            if(todayAttendance.length > 0) {
                const uniqueAvatars = [...new Map(todayAttendance.map(item => [item.avatar, item])).values()];
                uniqueAvatars.slice(0, 10).forEach((record, index) => {
                     const img = document.createElement('img');
                     img.src = record.avatar;
                     img.className = "picasso-avatar tooltip w-12 h-12";
                     img.title = record.name;
                     // Sedikit variasi rotasi untuk setiap avatar
                     img.style.transform = `rotate(${index % 2 === 0 ? '5deg' : '-5deg'})`;
                     avatarsContainer.appendChild(img);
                });
                if(todayAttendance.length > 10) {
                     const more = document.createElement('span');
                     more.className = "flex items-center justify-center w-14 h-14 bg-blue-900 text-white font-bold text-xl border-4 border-black shadow-[4px_4px_0px_var(--picasso-yellow)] picasso-title clip-path-polygon(0% 0%, 100% 0%, 100% 75%, 75% 75%, 75% 100%, 50% 75%, 0% 75%)";
                     more.innerText = `+${todayAttendance.length - 10}`;
                     avatarsContainer.appendChild(more);
                }
            } else {
                 avatarsContainer.innerHTML = '<span class="font-bold text-lg bg-white p-2 border-2 border-black transform skew-x-[-5deg]">Area ini masih kosong dari bentuk...</span>';
            }
        }

        function renderRecentScansTable() {
            const today = new Date().toLocaleDateString();
            const recentTbody = document.getElementById('recent-scan-table');
            recentTbody.innerHTML = '';
            const todayTodays = attendance.filter(a => a.date === today).reverse().slice(0, 5);
            if(todayTodays.length === 0) {
                 recentTbody.innerHTML = '<tr><td class="text-black font-bold py-4 text-center bg-gray-100 border-b-4 border-black">Belum ada fragmen hari ini.</td></tr>';
            } else {
                todayTodays.forEach(record => {
                    recentTbody.innerHTML += `
                        <tr class="hover:bg-yellow-200 transition border-b-4 border-black bg-white"><td class="py-4 px-2 flex items-center"><img src="${record.avatar}" class="w-12 h-12 mr-4 border-2 border-black bg-blue-200 clip-path-polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)"><div><div class="font-bold text-black text-xl picasso-title">${record.name}</div><div class="text-sm font-bold uppercase bg-black text-white inline-block px-1 transform skew-x-[-5deg]">${record.role} // <span class="font-mono">${record.time}</span></div></div></td></tr>
                    `;
                });
            }
        }

        function exportData() {
            let csv = "SUBJEK,KATEGORI,TANGGAL,JAM\n";
            attendance.forEach(row => { csv += `"${row.name}","${row.role}","${row.date}","${row.time}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `FRAGMEN_DATA_GKPS_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`);
            a.click();
        }

        function clearAttendance() {
            if(confirm('PERINGATAN: TINDAKAN INI AKAN MEDEKONSTRUKSI SELURUH DATA. LANJUTKAN?')) {
                attendance = []; localStorage.setItem('gkps_attendance', JSON.stringify(attendance)); renderAttendance(); updateStats();
            }
        }

        // Init Landing Page
        switchNav('home');
    </script>
</body>
</html>
