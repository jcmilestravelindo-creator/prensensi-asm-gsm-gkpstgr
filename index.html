<!DOCTYPE html>
<html lang="id">
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Absensi Kasih ULTRA MAX</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
font-family:Poppins;
margin:0;
background:linear-gradient(#87CEEB,#E0F7FF);
}

.header{
background:#38BDF8;
color:white;
text-align:center;
padding:15px;
font-weight:600;
}

.card{
background:white;
margin:15px;
padding:20px;
border-radius:16px;
box-shadow:0 5px 15px rgba(0,0,0,0.1);
}

.btn{
background:#0EA5E9;
color:white;
border:none;
padding:12px;
width:100%;
border-radius:12px;
margin-top:10px;
}

.nav{
position:fixed;
bottom:0;
width:100%;
background:white;
display:flex;
justify-content:space-around;
padding:10px;
}

.screen{display:none}
.active{display:block}

input,select{
width:100%;
padding:10px;
margin-top:5px;
border-radius:10px;
border:1px solid #ccc;
}

#reader{width:100%}
</style>
</head>

<body>

<div class="header">üôè Absensi Kasih ULTRA MAX</div>

<!-- LOGIN -->
<div id="login" class="screen active">
<div class="card">
<h3>Login</h3>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<select id="role">
<option>Guru</option>
<option>Admin</option>
</select>
<button class="btn" onclick="login()">Login</button>

<p>Admin: admin / 1234<br>Guru: guru / 1234</p>
</div>
</div>

<!-- HOME -->
<div id="home" class="screen">
<div class="card">
<h3>Dashboard</h3>

<select id="kelasSelect">
<option>Kelas A</option>
<option>Kelas B</option>
<option>Kelas C</option>
</select>

<h1 id="total">0</h1>
<p>Total Hadir</p>

<button class="btn" onclick="manual()">Absen Manual</button>
<button class="btn" onclick="exportCSV()">Export Excel</button>
</div>
</div>

<!-- SCAN -->
<div id="scan" class="screen">
<div class="card">
<h3>Scan QR</h3>
<div id="reader"></div>
</div>
</div>

<!-- LOG -->
<div id="logscreen" class="screen">
<div class="card">
<h3>Riwayat</h3>
<ul id="log"></ul>
</div>
</div>

<div class="nav">
<button onclick="show('home')">Home</button>
<button onclick="startScan()">Scan</button>
<button onclick="show('logscreen')">Riwayat</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* üî• GANTI CONFIG */
const firebaseConfig={
apiKey:"ISI",
authDomain:"ISI",
databaseURL:"ISI",
projectId:"ISI",
storageBucket:"ISI",
messagingSenderId:"ISI",
appId:"ISI"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let currentRole="Guru";

window.login=function(){
if((user.value==="admin"&&pass.value==="1234")||
(user.value==="guru"&&pass.value==="1234")){
currentRole=role.value;
show("home");
}else alert("Login salah");
}

window.show=function(id){
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

function absenRef(){
return ref(db,"absensi/"+kelasSelect.value);
}

function tambah(nama){
push(absenRef(),{
nama:nama,
waktu:new Date().toLocaleString(),
kelas:kelasSelect.value,
role:currentRole
});
}

window.manual=function(){
let n=prompt("Nama Anak:");
if(n) tambah(n);
}

let allData=[];

function load(){
onValue(absenRef(),snap=>{
let total=0;
log.innerHTML="";
allData=[];

snap.forEach(d=>{
let v=d.val();
total++;
allData.push(v);

let li=document.createElement("li");
li.innerText=`${v.nama} (${v.kelas}) - ${v.waktu}`;
log.appendChild(li);
});

document.getElementById("total").innerText=total;
});
}

kelasSelect.onchange=load;
load();

/* QR */
let qr;
window.startScan=function(){
show("scan");
qr=new Html5Qrcode("reader");

qr.start(
{facingMode:"environment"},
{fps:10,qrbox:250},
txt=>{
tambah(txt);
qr.stop();
show("home");
},
()=>{}
);
}

/* EXPORT */
window.exportCSV=function(){
let csv="Nama,Kelas,Waktu\n";
allData.forEach(d=>{
csv+=`${d.nama},${d.kelas},${d.waktu}\n`;
});

let blob=new Blob([csv],{type:"text/csv"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="absensi.csv";
a.click();
}

</script>

</body>
</html>
