<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Presensi ASM-GSM GKPS Tangerang (Online)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
glass: 'rgba(255, 255, 255, 0.65)',
glassBorder: 'rgba(255, 255, 255, 0.6)',
primary: '#6366f1',
},
fontFamily: {
sans: ['Plus Jakarta Sans', 'Inter', 'sans-serif'],
},
animation: {
'blob': 'blob 10s infinite',
'float': 'float 6s ease-in-out infinite',
'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
},
keyframes: {
blob: {
'0%': { transform: 'translate(0px, 0px) scale(1)' },
'33%': { transform: 'translate(30px, -50px) scale(1.1)' },
'66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
'100%': { transform: 'translate(0px, 0px) scale(1)' },
},
float: {
'0%, 100%': { transform: 'translateY(0)' },
'50%': { transform: 'translateY(-10px)' },
},
slideUp: {
'from': { opacity: 0, transform: 'translateY(40px)' },
'to': { opacity: 1, transform: 'translateY(0)' },
},
pop: {
'0%': { transform: 'scale(0.9)', opacity: 0 },
'100%': { transform: 'scale(1)', opacity: 1 },
}
}
}
}
</script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
::-webkit-scrollbar { width: 0px; background: transparent; }
body {
overscroll-behavior-y: none;
background-color: #f0f2f5;
font-family: 'Plus Jakarta Sans', sans-serif;
-webkit-tap-highlight-color: transparent;
}
.glass-panel {
background: rgba(255, 255, 255, 0.7);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border: 1px solid rgba(255, 255, 255, 0.6);
box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
}
.glass-card {
background: rgba(255, 255, 255, 0.85);
backdrop-filter: blur(12px);
border: 1px solid rgba(255, 255, 255, 0.8);
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
.glass-nav {
background: rgba(255, 255, 255, 0.8);
backdrop-filter: blur(25px);
-webkit-backdrop-filter: blur(25px);
border-top: 1px solid rgba(255, 255, 255, 0.5);
box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05);
}
@keyframes scan-line {
0% { top: 10%; opacity: 0; }
50% { opacity: 1; }
100% { top: 90%; opacity: 0; }
}
.animate-scan { animation: scan-line 2.5s ease-in-out infinite; }
#reader video {
object-fit: cover;
border-radius: 1.5rem;
width: 100% !important;
height: 100% !important;
}
.loader {
border: 4px solid #f3f3f3;
border-top: 4px solid #6366f1;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.pb-safe { padding-bottom: env(safe-area-inset-bottom, 24px); }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
<script type="importmap">
{
"imports": {
"react": "https://esm.sh/react@18.2.0",
"react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
"react-dom": "https://esm.sh/react-dom@18.2.0?deps=react@18.2.0",
"react-router-dom": "https://esm.sh/react-router-dom@6.22.0?deps=react@18.2.0,react-dom@18.2.0",
"lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
"recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
"react-qr-code": "https://esm.sh/react-qr-code@2.0.12?deps=react@18.2.0",
"firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
"firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
"firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
"firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
}
}
</script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import { HashRouter, Routes, Route, useNavigate, useLocation } from 'react-router-dom';
import {
LayoutDashboard, QrCode, Users, BarChart3, LogOut, Church, CreditCard,
CheckCircle, AlertCircle, Camera, Trash2, Download, Search, Upload,
ChevronRight, Calendar, User, ShieldCheck, Sparkles, Zap, Plus, X, RefreshCw, BookOpen, PenTool,
Bell, Activity, MessageSquare, Send, Radio, TrendingUp, Briefcase, GraduationCap, Clock, FileText, CalendarDays, MapPin, Edit, BrainCircuit, Cloud, CloudOff, FileSpreadsheet, File, Lock, Key, Power, Eye, Timer
} from 'lucide-react';
import { BarChart, Bar, ResponsiveContainer, PieChart, Pie, Cell, Tooltip, XAxis, YAxis, CartesianGrid } from 'recharts';
import QRCode from 'react-qr-code';
// --- FIREBASE INTEGRATION ---
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
import { getAuth, signInAnonymously, signInWithCustomToken } from "firebase/auth";
import { getFirestore, collection, getDocs, setDoc, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "firebase/firestore";
// CONFIGURATION HANDLING
// Cobalah menggunakan config environment jika tersedia (untuk preview),
// jika tidak, gunakan config hardcoded milik user.
let firebaseConfig;
try {
firebaseConfig = JSON.parse(__firebase_config);
} catch (e) {
// Fallback ke config user jika variabel environment tidak ada
firebaseConfig = {
apiKey: "AIzaSyDDtjCJO09qP3kwOcoctObU-qOg-GTnrTE",
authDomain: "sundayschoolattendance-58661.firebaseapp.com",
databaseURL: "https://sundayschoolattendance-58661-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "sundayschoolattendance-58661",
storageBucket: "sundayschoolattendance-58661.firebasestorage.app",
messagingSenderId: "1055300658311",
appId: "1:1055300658311:web:2db2708b0c8bfa5aa54422",
measurementId: "G-PCB8J7RRHJ"
};
}
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);
// --- APP ID FOR PATHING ---
// PENTING: Gunakan App ID ini untuk path Firestore agar tidak kena error "Missing permissions"
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
// Helper untuk mendapatkan referensi koleksi di path yang benar
const getCollectionRef = (colName) => {
return collection(db, 'artifacts', appId, 'public', 'data', colName);
};
// Helper untuk mendapatkan referensi dokumen di path yang benar
const getDocRef = (colName, docId) => {
return doc(db, 'artifacts', appId, 'public', 'data', colName, String(docId));
};
// --- TIMEZONE FIX HELPER (CRITICAL FOR ATTENDANCE) ---
// Memaksa waktu server/aplikasi mengikuti Waktu Indonesia Barat (GMT+7)
// Apapun settingan jam di HP user, data yang masuk akan tetap dianggap tanggal WIB.
const getLocalDate = () => {
const now = new Date();
// Konversi waktu saat ini ke UTC Timestamp
const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
// Tambahkan offset 7 Jam (WIB) secara manual
const wibTime = new Date(utc + (7 * 3600000));
const year = wibTime.getFullYear();
const month = String(wibTime.getMonth() + 1).padStart(2, '0');
const day = String(wibTime.getDate()).padStart(2, '0');
return `${year}-${month}-${day}`;
};
// --- FIREBASE HELPERS ---
const syncFromFirestore = async () => {
if (!auth.currentUser) return false; // Jangan sync jika offline
const collections = [
{ name: 'users', key: 'gkps_users_v3' },
{ name: 'attendance', key: 'gkps_att_v3' },
{ name: 'schedules', key: 'gkps_sched_v3' },
{ name: 'materials', key: 'gkps_mat_v3' },
{ name: 'activities', key: 'gkps_act_v3' },
{ name: 'notifications', key: 'gkps_notif_v3' }
];
let hasData = false;
try {
for (const col of collections) {
const querySnapshot = await getDocs(getCollectionRef(col.name));
const data = [];
querySnapshot.forEach((doc) => {
data.push(doc.data());
});
if (data.length > 0) {
localStorage.setItem(col.key, JSON.stringify(data));
hasData = true;
}
}
console.log("âœ… Sync complete from Firestore");
} catch (e) {
console.error("Gagal sinkronisasi data:", e);
}
return hasData;
};
const pushToFirestore = async (collectionName, data, id) => {
try {
// Pastikan user terautentikasi sebelum menulis
if (auth.currentUser) {
await setDoc(getDocRef(collectionName, id), data);
console.log(`âœ… Berhasil simpan ke ${collectionName}:`, id);
} else {
console.warn("âš ï¸ Offline: Data disimpan lokal saja.");
}
} catch (e) {
console.error(`âŒ Gagal push ke Firestore (${collectionName}):`, e);
}
};
const deleteFromFirestore = async (collectionName, id) => {
try {
if (auth.currentUser) {
await deleteDoc(getDocRef(collectionName, id));
}
} catch (e) {
console.error("Gagal hapus di Firestore:", e);
}
}
// --- DATA & CONFIG ---
const MOCK_VERSES = [
"Amsal 1:7 - Takut akan TUHAN adalah permulaan pengetahuan.",
"Filipi 4:13 - Segala perkara dapat kutanggung di dalam Dia.",
"Yosua 1:9 - Bukankah telah Kuperintahkan kepadamu: kuatkan dan teguhkanlah hatimu?",
"Yeremia 29:11 - Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu."
];
const ML_HEROES = [
"Alucard", "Miya", "Layla", "Zilong", "Tigreal", "Nana", "Eudora", "Gord",
"Saber", "Balmond", "Akai", "Franco", "Chou", "Gusion", "Fanny", "Lesley"
];
const JACOB_SONS = [
"Ruben", "Simeon", "Lewi", "Yehuda", "Dan", "Naftali",
"Gad", "Asyer", "Isakhar", "Zebulon", "Yusuf", "Benyamin"
];
const UserRole = { ADMIN: 'ADMIN', TEACHER: 'TEACHER', STUDENT: 'STUDENT' };
const STORAGE = {
USERS: 'gkps_users_v3',
ATTENDANCE: 'gkps_att_v3',
CLASSES: 'gkps_cls_v3',
SESSION: 'gkps_sess_v3',
MATERIALS: 'gkps_mat_v3',
ACTIVITIES: 'gkps_act_v3',
NOTIFICATIONS: 'gkps_notif_v3',
SCHEDULES: 'gkps_sched_v3'
};
const DEFAULT_USERS = [
{ id: '1', name: 'Admin Utama', role: 'ADMIN', qrCode: 'ADMIN-001', gender: 'Laki-Laki', pin: 'admin123', isActive: true, lastLogin: new Date().toISOString() },
{ id: '2', name: 'Guru Sekolah Minggu', role: 'TEACHER', className: 'Kelas Daud', qrCode: 'GURU-001', gender: 'Perempuan', pin: '123456', isActive: true },
{ id: '3', name: 'Timothy Simanjuntak', role: 'STUDENT', className: 'Kelas Daud', qrCode: 'S-001', gender: 'Laki-Laki', pin: '123456', isActive: true },
{ id: '4', name: 'Sarah Damanik', role: 'STUDENT', className: 'Kelas Ester', qrCode: 'S-002', gender: 'Perempuan', pin: '123456', isActive: true },
];
const DEFAULT_CLASSES = [
{ id: 'c1', name: 'Kelas Daud', desc: '4-6 Tahun' },
{ id: 'c2', name: 'Kelas Daniel', desc: '7-9 Tahun' },
{ id: 'c3', name: 'Kelas Paulus', desc: '10-12 Tahun' },
{ id: 'c4', name: 'Kelas Ester', desc: '13+ Tahun' }
];
const DEFAULT_SCHEDULES = [
{ id: 's1', className: 'Kelas Daud', date: getLocalDate(), time: '08:00 - 09:30', activity: 'Ibadah Minggu', theme: 'Tuhan Yesus Baik', speaker: 'Kak Lisa', location: 'R. Daud Lt. 1', status: 'upcoming' },
{ id: 's2', className: 'Kelas Daniel', date: getLocalDate(), time: '08:00 - 09:30', activity: 'Ibadah & Aktivitas', theme: 'Daud Melawan Goliat', speaker: 'Kak Budi', location: 'R. Daniel Lt. 1', status: 'upcoming' },
];
// --- GEMINI AI SERVICE ---
const GeminiService = {
call: async (prompt) => {
const apiKey = ""; // API Key
const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
const payload = {
contents: [{ parts: [{ text: prompt }] }],
generationConfig: { responseMimeType: "application/json" }
};
const delays = [1000, 2000, 4000];
for (let i = 0; i <= 3; i++) {
try {
const response = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});
if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
const data = await response.json();
const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
return JSON.parse(text);
} catch (error) {
if (i === 3) throw error;
await new Promise(resolve => setTimeout(resolve, delays[i]));
}
}
}
};
// --- SERVICES (MODIFIED FOR FIREBASE) ---
const DB = {
get: (key, def) => {
try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; }
},
set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
users: {
update: (updatedUser) => {
const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
const index = users.findIndex(u => u.id === updatedUser.id);
if (index !== -1) {
users[index] = updatedUser;
DB.set(STORAGE.USERS, users);
pushToFirestore('users', updatedUser, updatedUser.id);
return true;
}
users.push(updatedUser);
DB.set(STORAGE.USERS, users);
pushToFirestore('users', updatedUser, updatedUser.id);
return true;
},
add: (newUser) => {
const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
users.push(newUser);
DB.set(STORAGE.USERS, users);
pushToFirestore('users', newUser, newUser.id);
},
delete: (id) => {
const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
const updated = users.filter(u => u.id !== id);
DB.set(STORAGE.USERS, updated);
deleteFromFirestore('users', id);
}
},
att: {
add: (record) => {
const all = DB.get(STORAGE.ATTENDANCE, []);
// Check duplicate strictly on user ID and DATE string (WIB)
const today = getLocalDate();
if (all.some(r => r.userId === record.userId && r.date === today)) return false;
DB.set(STORAGE.ATTENDANCE, [...all, record]);
pushToFirestore('attendance', record, record.id);
return true;
}
},
materials: {
getLatest: (className) => {
const all = DB.get(STORAGE.MATERIALS, []);
const classMaterials = all.filter(m => m.className === className);
return classMaterials.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
},
save: (material) => {
const all = DB.get(STORAGE.MATERIALS, []);
DB.set(STORAGE.MATERIALS, [material, ...all]);
pushToFirestore('materials', material, material.id);
}
},
activities: {
add: (userName, action) => {
const all = DB.get(STORAGE.ACTIVITIES, []);
const newLog = { id: Date.now(), userName, action, timestamp: new Date().toISOString() };
DB.set(STORAGE.ACTIVITIES, [newLog, ...all].slice(0, 50));
pushToFirestore('activities', newLog, newLog.id);
},
get: () => DB.get(STORAGE.ACTIVITIES, [])
},
notifications: {
broadcast: (title, message, sender, scheduledTime = null) => {
const all = DB.get(STORAGE.NOTIFICATIONS, []);
const newNotif = {
id: Date.now(),
title,
message,
sender,
timestamp: new Date().toISOString(),
scheduledTime: scheduledTime ? scheduledTime : new Date().toISOString(),
status: scheduledTime && new Date(scheduledTime) > new Date() ? 'scheduled' : 'sent'
};
DB.set(STORAGE.NOTIFICATIONS, [newNotif, ...all]);
pushToFirestore('notifications', newNotif, newNotif.id);
},
get: () => DB.get(STORAGE.NOTIFICATIONS, [])
},
schedules: {
get: (className) => {
const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
if (!className || className === 'ALL') return all;
return all.filter(s => s.className === className);
},
add: (sched) => {
const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
DB.set(STORAGE.SCHEDULES, [sched, ...all]);
pushToFirestore('schedules', sched, sched.id);
},
update: (updatedSched) => {
const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
const index = all.findIndex(s => s.id === updatedSched.id);
if (index !== -1) {
all[index] = updatedSched;
DB.set(STORAGE.SCHEDULES, all);
pushToFirestore('schedules', updatedSched, updatedSched.id);
return true;
}
return false;
},
delete: (id) => {
const all = DB.get(STORAGE.SCHEDULES, DEFAULT_SCHEDULES);
DB.set(STORAGE.SCHEDULES, all.filter(s => s.id !== id));
deleteFromFirestore('schedules', id);
}
}
};
// --- HELPER ---
const formatDateIndo = (dateStr) => {
const date = new Date(dateStr);
return date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
};
const isNotifVisible = (n) => {
if (!n.scheduledTime) return true;
return new Date(n.scheduledTime) <= new Date();
};
// --- UI COMPONENTS ---
const Background = () => (
<div className="fixed inset-0 overflow-hidden pointer-events-none -z-10 bg-[#f3f4f6]">
<div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-50/50 via-purple-50/50 to-pink-50/50"></div>
<div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
<div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
<div className="absolute -bottom-32 left-20 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
</div>
);
const Button = ({ children, onClick, variant = 'primary', className = '' }) => {
const styles = {
primary: "bg-gradient-to-r from-indigo-600 to-pink-500 text-white shadow-lg shadow-indigo-500/30 border-0",
secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
glass: "bg-white/40 backdrop-blur-md border border-white/60 text-indigo-700 hover:bg-white/60",
danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100"
};
return (
<button onClick={onClick} className={`w-full py-4 rounded-2xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 ${styles[variant]} ${className}`}>
{children}
</button>
);
};
const Avatar = ({ name, seed, style = 'avataaars', size = 'md', className='', onClick }) => {
const s = size === 'lg' ? 'w-16 h-16 text-2xl' : size === 'xl' ? 'w-24 h-24 text-4xl' : 'w-10 h-10 text-sm';
const avatarSeed = seed || name;
const src = `https://api.dicebear.com/7.x/${style}/svg?seed=${avatarSeed}&backgroundColor=transparent`;
return (
<div onClick={onClick} className={`${s} rounded-full bg-gradient-to-tr from-indigo-400 to-pink-400 p-0.5 shadow-lg ${className} ${onClick ? 'cursor-pointer hover:scale-105 transition-transform' : ''}`}>
<div className="w-full h-full bg-white rounded-full flex items-center justify-center overflow-hidden">
<img
src={src}
alt={name}
className="w-full h-full object-cover"
onError={(e) => {e.target.src = `https://api.dicebear.com/7.x/initials/svg?seed=${name}`}}
/>
</div>
</div>
);
};
const LoadingScreen = () => (
<div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 relative overflow-hidden">
<Background />
<div className="glass-panel p-8 rounded-3xl flex flex-col items-center gap-4 animate-pop">
<div className="loader"></div>
<p className="text-slate-600 font-bold text-sm">Menghubungkan Database...</p>
</div>
</div>
);
// --- MODALS & SCREENS ---
// ... [Kode ScheduleManagerModal, NotificationModal, ProfileModal, MaterialModal tetap sama - TIDAK DIUBAH] ...
// ... [Kode LoginScreen, UserManagement tetap sama - TIDAK DIUBAH] ...

// --- DASHBOARD DENGAN PERBAIKAN KRUSIAL ---
const Dashboard = ({ user }) => {
// FIX: GUNAKAN getLocalDate() AGAR TANGGAL DEFAULT SESUAI JAM LOKAL
const [date, setDate] = useState(getLocalDate());
const [att, setAtt] = useState([]);
const [activities, setActivities] = useState([]);
const [users, setUsers] = useState([]);
const [isMatModalOpen, setIsMatModalOpen] = useState(false);
const [isSchedModalOpen, setIsSchedModalOpen] = useState(false);
const [bcTitle, setBcTitle] = useState('');
const [bcMsg, setBcMsg] = useState('');
// FIX: GUNAKAN getLocalDate()
const [bcDate, setBcDate] = useState(getLocalDate());
const [bcTime, setBcTime] = useState(new Date().toTimeString().slice(0,5));
const [pendingBroadcasts, setPendingBroadcasts] = useState([]);
const [aiAnalysis, setAiAnalysis] = useState(null);
const [isAnalyzing, setIsAnalyzing] = useState(false);
const [aiDevotional, setAiDevotional] = useState(null);
const [loadingDevo, setLoadingDevo] = useState(false);

// ðŸ”¥ PERBAIKAN KRUSIAL: Listener Attendance yang benar
useEffect(() => {
  if (!auth.currentUser) return; // Guard clause
  
  // Listener Attendance - HANYA filter berdasarkan state date
  const unsubscribeAtt = onSnapshot(getCollectionRef('attendance'), (snapshot) => {
    const data = snapshot.docs.map(doc => doc.data());
    // ðŸ”¥ PENTING: Filter LANGSUNG berdasarkan state date (bukan ambil dari localStorage)
    setAtt(data.filter(r => r.date === date));
    console.log("âœ“ Attendance updated:", data.filter(r => r.date === date).length, "records for", date);
  }, (error) => {
    console.error("Error fetching attendance:", error);
  });
  
  // Listener Activities
  const unsubscribeAct = onSnapshot(getCollectionRef('activities'), (snapshot) => {
    const data = snapshot.docs.map(doc => doc.data());
    data.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    localStorage.setItem(STORAGE.ACTIVITIES, JSON.stringify(data));
    setActivities(data);
  }, (error) => {
    console.error("Error fetching activities:", error);
  });
  
  let unsubscribeUsers = () => {};
  if (user.role === 'ADMIN') {
    unsubscribeUsers = onSnapshot(getCollectionRef('users'), (snapshot) => {
      const data = snapshot.docs.map(doc => doc.data());
      localStorage.setItem(STORAGE.USERS, JSON.stringify(data));
      setUsers(data);
    }, (error) => {
      console.error("Error fetching users:", error);
    });
  } else {
    setUsers(DB.get(STORAGE.USERS, DEFAULT_USERS));
  }
  
  // Load Pending Broadcasts
  const allNotifs = DB.notifications.get();
  setPendingBroadcasts(allNotifs.filter(n => n.status === 'scheduled' && new Date(n.scheduledTime) > new Date()));
  
  // ðŸ”¥ HAPUS: Initial load dari localStorage (karena listener langsung update state)
  // const allAtt = DB.get(STORAGE.ATTENDANCE, []);
  // setAtt(allAtt.filter(r => r.date === date));
  
  return () => {
    if(unsubscribeAtt) unsubscribeAtt();
    if(unsubscribeAct) unsubscribeAct();
    if(unsubscribeUsers) unsubscribeUsers();
  };
}, [date, user.role]); // Dependency tetap date dan user.role

// ... [Sisa kode Dashboard tetap sama - stats, weeklyData, handlers, dll] ...
// ... [Kode render Dashboard tetap sama] ...
};

// --- SCANNER DENGAN PERBAIKAN KRUSIAL ---
const Scanner = ({ user }) => {
const [status, setStatus] = useState({ type: 'idle', msg: '' });
const [manual, setManual] = useState(false);
const [txt, setTxt] = useState('');
const ref = useRef(null);
const onScan = (code) => {
if (status.type !== 'idle') return;
try {
if(ref.current && ref.current.getState() === 2) {
ref.current.pause();
}
} catch(e) { console.log("Pause error:", e); }
const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
const u = users.find(x => x.qrCode === code || x.id === code || x.name.toLowerCase() === code.toLowerCase());
if (!u) {
setStatus({ type: 'err', msg: 'Data Tidak Ditemukan' });
} else {
let isAllowed = false;
if (user.role === 'ADMIN') {
isAllowed = true;
} else if (user.role === 'TEACHER') {
if (u.role === 'STUDENT' && u.className === user.className) {
isAllowed = true;
} else if (u.role === 'TEACHER') {
setStatus({ type: 'err', msg: 'Hanya Admin yang bisa scan Guru.' });
setTimeout(() => { setStatus({ type: 'idle', msg: '' }); try { if(ref.current && ref.current.getState() === 3) ref.current.resume(); } catch(e){} }, 2000);
return;
} else {
setStatus({ type: 'err', msg: 'Siswa beda kelas / Akses ditolak' });
setTimeout(() => { setStatus({ type: 'idle', msg: '' }); try { if(ref.current && ref.current.getState() === 3) ref.current.resume(); } catch(e){} }, 2000);
return;
}
} else {
isAllowed = false;
}
if (isAllowed) {
// ðŸ”¥ PENTING: Gunakan getLocalDate() yang SAMA dengan Dashboard
const today = getLocalDate();
const ok = DB.att.add({
id: Date.now(), 
userId: u.id, 
userName: u.name, 
className: u.className || '-', 
role: u.role,
date: today, // ðŸ”¥ Konsisten dengan Dashboard
timestamp: new Date().toISOString(),
avatarSeed: u.avatarSeed,
avatarStyle: u.avatarStyle || 'avataaars'
});
if (ok) {
DB.activities.add(user.name, `Memindai kehadiran ${u.name} (${u.role})`);
setStatus({ type: 'ok', msg: `Berhasil: ${u.name}` });
// ðŸ”¥ Force trigger localStorage event untuk sinkronisasi antar tab
window.dispatchEvent(new Event('storage'));
} else {
setStatus({ type: 'err', msg: 'Sudah Absen Hari Ini' });
}
}
}
setTimeout(() => {
setStatus({ type: 'idle', msg: '' });
try {
if(ref.current && ref.current.getState() === 3) {
ref.current.resume();
}
} catch(e) { console.log("Resume error:", e); }
}, 2000);
};
// ... [Sisa kode Scanner tetap sama] ...
};

// ... [Kode StudentDashboard, MainApp tetap sama - TIDAK DIUBAH] ...

// --- APP DENGAN GLOBAL LISTENERS YANG BENAR ---
const App = () => {
const [user, setUser] = useState(null);
const [isReady, setIsReady] = useState(false);
useEffect(() => {
const initApp = async () => {
try {
// CRITICAL: Auth Flow
if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
await signInWithCustomToken(auth, __initial_auth_token);
console.log("âœ… Logged in with Custom Token");
} else {
await signInAnonymously(auth);
console.log("âœ… Logged in Anonymously");
}

// âš ï¸ PENTING: Sync DULU sebelum setup listener
await syncFromFirestore();
console.log("âœ… Sync selesai, sekarang setup listener...");

// ðŸ”¥ SETUP GLOBAL LISTENERS SETELAH SYNC
// Listener Attendance Global - sinkronisasi localStorage
const unsubscribeAtt = onSnapshot(
getCollectionRef('attendance'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.ATTENDANCE, JSON.stringify(data));
console.log("âœ“ Global: Attendance updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Attendance listener error:", error);
}
);

// Listener Users Global
const unsubscribeUsers = onSnapshot(
getCollectionRef('users'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.USERS, JSON.stringify(data));
console.log("âœ“ Global: Users updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Users listener error:", error);
}
);

// Listener Activities Global
const unsubscribeAct = onSnapshot(
getCollectionRef('activities'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.ACTIVITIES, JSON.stringify(data));
console.log("âœ“ Global: Activities updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Activities listener error:", error);
}
);

// Listener Notifications Global
const unsubscribeNotif = onSnapshot(
getCollectionRef('notifications'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.NOTIFICATIONS, JSON.stringify(data));
console.log("âœ“ Global: Notifications updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Notifications listener error:", error);
}
);

// Listener Schedules Global
const unsubscribeSched = onSnapshot(
getCollectionRef('schedules'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.SCHEDULES, JSON.stringify(data));
console.log("âœ“ Global: Schedules updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Schedules listener error:", error);
}
);

// Listener Materials Global
const unsubscribeMat = onSnapshot(
getCollectionRef('materials'),
(snapshot) => {
const data = snapshot.docs.map(doc => doc.data());
localStorage.setItem(STORAGE.MATERIALS, JSON.stringify(data));
console.log("âœ“ Global: Materials updated from Firestore:", data.length, "records");
},
(error) => {
console.error("Materials listener error:", error);
}
);

// Cleanup listeners saat component unmount
return () => {
if (unsubscribeAtt) unsubscribeAtt();
if (unsubscribeUsers) unsubscribeUsers();
if (unsubscribeAct) unsubscribeAct();
if (unsubscribeNotif) unsubscribeNotif();
if (unsubscribeSched) unsubscribeSched();
if (unsubscribeMat) unsubscribeMat();
};

} catch (e) {
console.error("Initialization Error:", e);
if (e.code === 'auth/configuration-not-found' || e.code === 'auth/admin-restricted-operation') {
alert("PERINGATAN: Fitur 'Anonymous Sign-in' belum diaktifkan di Firebase Console. Aplikasi berjalan dalam MODE OFFLINE (Data hanya tersimpan di browser ini dan tidak akan disinkronisasi ke server).");
} else if (e.code === 'auth/operation-not-allowed') {
alert("PERINGATAN: Operasi login tidak diizinkan. Cek setting Authentication di Firebase Console.");
}
} finally {
setIsReady(true);
}

// Load session
const s = DB.get(STORAGE.SESSION);
if(s) {
const users = DB.get(STORAGE.USERS, DEFAULT_USERS);
const freshUser = users.find(u => u.id === s.id);
if(freshUser && freshUser.isActive !== false) {
setUser(freshUser || s);
} else {
localStorage.removeItem(STORAGE.SESSION);
}
}
};
initApp();
}, []);
// ... [Sisa kode App tetap sama - login, logout, render] ...
};
createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
