<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi GKPS - PRO ULTIMATE Enhanced</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --accent: #facc15;
            --bg-soft: #f0f9ff;
            --text-main: #1e293b;
            --wa-green: #25D366;
            --wa-teal: #128C7E;
        }
        body { font-family: 'Poppins', sans-serif; color: var(--text-main); background: linear-gradient(180deg, #e0f2fe 0%, #f0f9ff 100%); min-height: 100vh; padding-bottom: 2rem; }
        
        /* UI Card & Input */
        .pro-card { background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 30px -5px rgba(14, 165, 233, 0.15); border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
        .pro-input { width: 100%; padding: 0.8rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.8rem; background: #f8fafc; outline: none; transition: 0.2s; font-size: 0.95rem; margin-bottom: 1rem; }
        .pro-input:focus { border-color: var(--primary); background: white; }
        .pro-btn { width: 100%; padding: 0.8rem; border-radius: 0.8rem; font-weight: 700; transition: 0.2s; text-align: center; cursor: pointer; border: none; margin-top: 0.5rem; }
        .btn-blue { background: var(--primary); color: white; } .btn-blue:hover { background: var(--primary-dark); }
        .btn-red { background: #ef4444; color: white; } .btn-red:hover { background: #dc2626; }
        
        .pass-wrapper { position: relative; width: 100%; }
        .pass-toggle { position: absolute; right: 15px; top: 42%; transform: translateY(-50%); cursor: pointer; z-index: 10; font-size: 1.2rem; color: #94a3b8; user-select: none; }
        
        .nav-pill { padding: 0.5rem 1rem; border-radius: 99px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: 0.2s; color: #64748b; background: white; border: 1px solid transparent; white-space: nowrap; }
        .nav-pill.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.4); }

        /* --- [PENTING] PERBAIKAN SCANNER RESPONSIVE --- */
        #scanner-container { 
            position: relative; 
            width: 100%; 
            background: #000; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            /* Menggunakan min-height agar fleksibel di laptop (tidak gepeng) */
            min-height: 300px; 
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Bingkai Scanner Statis 250px (Sinkron dengan JS) */
        .scan-frame { 
            width: 250px; 
            height: 250px; 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            border-radius: 20px; 
            position: relative; 
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); 
        }
        .scan-laser { position: absolute; width: 100%; height: 2px; background: #3b82f6; box-shadow: 0 0 10px #3b82f6; top: 0; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }

        /* --- [PENTING] PERBAIKAN QR CODE HIGH RES --- */
        #qrcode {
            width: 180px;  /* Tampilan fisik di layar */
            height: 180px;
            margin: 0 auto;
            background: white;
            padding: 5px;
        }
        /* Memaksa gambar besar (1000px) pas di kotak kecil tanpa pecah */
        #qrcode img, #qrcode canvas {
            width: 100% !important;
            height: auto !important;
            display: block;
            image-rendering: -webkit-optimize-contrast; 
        }

        /* Styles Tambahan */
        .admin-table th { background: #f1f5f9; color: #64748b; font-size: 0.75rem; text-transform: uppercase; padding: 0.8rem; text-align: left; }
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 700; display: inline-block; }
        .badge-active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-disabled { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .conn-status { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: #22c55e; color: white; padding: 5px 15px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 100; }
        .conn-status.offline { background: #ef4444; }

        /* Modal & WA Notification */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; padding: 1rem; backdrop-filter: blur(2px); }
        .modal-content { background: white; border-radius: 1.5rem; width: 100%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .wa-dropdown { display: none; position: absolute; right: -10px; top: 140%; width: 320px; background: #efe7dd; border-radius: 12px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); z-index: 100; overflow: hidden; flex-direction: column; }
        .wa-dropdown.show { display: flex; animation: slideUp 0.2s ease; }
        .wa-header { background: var(--wa-teal); color: white; padding: 10px 15px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body class="p-4">

    <div id="conn-indicator" class="conn-status offline">üî¥ Offline - Menghubungkan...</div>

    <section id="screen-login" class="max-w-md mx-auto min-h-screen flex flex-col justify-center">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-900 tracking-tight">GKPS TANGERANG</h1>
            <p class="text-gray-500 font-medium">Sistem Absensi Terpadu</p>
        </div>
        <div class="pro-card">
            <input type="text" id="login-username" class="pro-input" placeholder="Username">
            <div class="pass-wrapper">
                <input type="password" id="login-password" class="pro-input" placeholder="Password">
                <span onclick="togglePass('login-password', this)" class="pass-toggle">üëÅÔ∏è</span>
            </div>
            <button onclick="handleLogin()" class="pro-btn btn-blue shadow-lg">MASUK</button>
            <div class="mt-4 text-center text-xs text-blue-500 font-bold cursor-pointer">Lupa Password?</div>
        </div>
    </section>

    <section id="screen-dashboard" class="hidden max-w-5xl mx-auto pt-4">
        <header class="flex justify-between items-center mb-6 relative">
            <div class="flex items-center gap-3">
                <img id="dash-avatar" src="" class="w-12 h-12 rounded-full border-2 border-blue-500 bg-white object-cover">
                <div>
                    <h1 class="text-xl font-bold text-blue-900">Dashboard</h1>
                    <span id="role-badge" class="bg-yellow-200 text-yellow-800 text-[10px] px-2 py-0.5 rounded uppercase">ROLE</span>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <div class="relative notif-container">
                    <button onclick="toggleNotificationPanel()" class="focus:outline-none text-2xl">üí¨</button>
                    <div id="dash-wa-panel" class="wa-dropdown">
                        <div class="wa-header">Pesan Masuk</div>
                        <div id="dash-wa-list" class="p-2 flex flex-col gap-2 overflow-y-auto max-h-60"></div>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-500 text-xs font-bold border border-red-200 px-3 py-1 rounded-full">Keluar</button>
            </div>
        </header>

        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="switchTab('home')" id="tab-home" class="nav-pill active">üìä Home</button>
            <button onclick="switchTab('scan')" id="tab-scan" class="nav-pill">üì∑ Scan</button>
            <button onclick="switchTab('users')" id="tab-users" class="nav-pill hidden">üë• Users</button>
            <button onclick="switchTab('materi')" id="tab-materi" class="nav-pill hidden">üìö Materi</button>
            <button onclick="switchTab('jadwal')" id="tab-jadwal" class="nav-pill hidden">üóìÔ∏è Jadwal</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="nav-pill hidden">‚öôÔ∏è Pengaturan</button>
        </div>

        <div id="view-home" class="tab-view">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-600 text-white p-5 rounded-2xl shadow-lg">
                    <div class="text-3xl font-extrabold" id="count-present">0</div>
                    <div class="text-xs opacity-90">Hadir Hari Ini</div>
                </div>
                <div onclick="switchTab('scan')" class="bg-white border border-gray-100 p-5 rounded-2xl shadow-lg flex flex-col items-center cursor-pointer">
                    <div class="text-2xl mb-1">üì∑</div>
                    <div class="font-bold text-gray-700 text-xs">Mulai Scan</div>
                </div>
            </div>
            <div class="pro-card">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Log Kehadiran</h3>
                <div class="overflow-x-auto max-h-[300px]">
                    <table class="w-full admin-table">
                        <thead><tr><th>Jam</th><th>Nama</th><th>Status</th></tr></thead>
                        <tbody id="table-attendance"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-scan" class="tab-view hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-3xl overflow-hidden shadow-2xl relative w-full border border-gray-200">
                    <div id="scanner-error" class="hidden p-6 text-center text-red-500 font-bold bg-red-50">
                        <span id="scanner-error-msg">Akses kamera ditolak.</span>
                    </div>
                    <div id="scanner-container">
                        <div id="reader"></div> 
                        <div class="scan-overlay">
                            <div id="scan-frame" class="scan-frame">
                                <div class="scan-laser"></div>
                            </div>
                            <div class="mt-4 text-white text-[10px] font-bold bg-black/40 px-3 py-1 rounded-full">Posisikan QR dalam kotak</div>
                        </div>
                    </div>
                </div>
                <div id="scan-status" class="mt-4 text-center font-bold p-3 rounded-xl hidden shadow-lg text-sm transition-all"></div>
            </div>
        </div>

        <div id="view-users" class="tab-view hidden">
            <div class="pro-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Kelola Pengguna</h3>
                    <button onclick="openUserModal()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded-full font-bold">+ User</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full admin-table">
                        <thead><tr><th>User</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody id="table-users"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="view-materi" class="tab-view hidden"><div class="pro-card p-10 text-center text-gray-400">Fitur Materi</div></div>
        <div id="view-jadwal" class="tab-view hidden"><div class="pro-card p-10 text-center text-gray-400">Fitur Jadwal</div></div>

        <div id="view-settings" class="tab-view hidden">
             <div class="pro-card bg-green-50 border-green-200">
                <h3 class="font-bold text-green-900">Pengaturan Sistem</h3>
                <button onclick="emergencyReset()" class="pro-btn btn-red mt-2">‚ö†Ô∏è Reset Database (Darurat)</button>
            </div>
        </div>
    </section>

    <section id="screen-siswa" class="hidden max-w-md mx-auto pt-8">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <img id="stu-avatar" src="" class="w-12 h-12 rounded-full border-2 border-blue-500 object-cover">
                <h2 class="text-xl font-bold text-blue-900">Halo, <span id="siswa-greet-name">Siswa</span>!</h2>
            </div>
            <button onclick="logout()" class="text-red-500 text-xs font-bold border border-red-200 px-3 py-1 rounded-full">Keluar</button>
        </header>
        <div class="student-card pro-card p-0 overflow-hidden" style="max-width:350px; margin:auto;">
            <div class="bg-blue-700 h-3 w-full"></div>
            <div class="p-6 flex flex-col items-center">
                <div class="w-24 h-32 bg-gray-100 rounded-lg overflow-hidden border-2 border-white shadow-md mb-4">
                    <img id="card-img" src="" class="w-full h-full object-cover">
                </div>
                <h3 id="card-name-display" class="font-bold text-lg text-gray-800 uppercase">NAMA SISWA</h3>
                <p id="card-id-display" class="text-xs text-gray-400 mb-4">ID: -</p>
                
                <div class="p-2 bg-white rounded-xl border-2 border-blue-100 shadow-sm">
                    <div id="qrcode"></div>
                </div>
                
                <p class="text-[9px] text-gray-400 mt-2">Scan QR untuk absen</p>
            </div>
        </div>
    </section>

    <div id="user-modal" class="modal-overlay">
        <div class="modal-content p-6">
            <h3 class="font-bold text-lg mb-4">Edit User</h3>
            <input type="hidden" id="modal-id">
            <input type="text" id="modal-name" class="pro-input" placeholder="Nama Lengkap">
            <input type="text" id="modal-username" class="pro-input" placeholder="Username">
            <select id="modal-role" class="pro-input">
                <option value="siswa">Siswa</option>
                <option value="guru">Guru</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="saveUser()" class="pro-btn btn-blue">Simpan</button>
            <button onclick="closeModal()" class="pro-btn bg-gray-200 text-gray-600 mt-2">Batal</button>
        </div>
    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCH-_9wgq0Mw8JSqw2PtUUJy7KEPaHHZxM",
            authDomain: "absensigkps.firebaseapp.com",
            databaseURL: "https://absensigkps-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensigkps",
            storageBucket: "absensigkps.firebasestorage.app",
            appId: "1:327391538920:web:04261da312429076e2635d"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('gkps_data');

        // STATE VARIABLES
        let db = { users: [], attendance: [], messages: [] };
        let currentUser = null;
        let html5QrCode = null;
        let isScanning = false;

        // --- MAIN APP INIT ---
        function initApp() {
            const saved = localStorage.getItem('gkps_session');
            if (saved) {
                currentUser = JSON.parse(saved);
                if (currentUser.role === 'siswa') { renderSiswaScreen(); showScreen('siswa'); }
                else { renderDashboardScreen(); showScreen('dashboard'); }
            } else { showScreen('login'); }

            dbRef.on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    db = val;
                    if (currentUser) {
                        const fresh = (db.users||[]).find(u => u.username === currentUser.username);
                        if (fresh) { currentUser = fresh; localStorage.setItem('gkps_session', JSON.stringify(currentUser)); }
                    }
                    updateUI();
                } else { createDefaultAdmin(); }
            });

            firebase.database().ref(".info/connected").on("value", (snap) => {
                const el = document.getElementById('conn-indicator');
                if (snap.val() === true) { el.innerText = "üü¢ Online"; el.className = "conn-status"; }
                else { el.innerText = "üî¥ Offline"; el.className = "conn-status offline"; }
            });
        }

        // --- HELPER FUNCTIONS ---
        function createDefaultAdmin() {
            db.users = [{ id: 'ADM_1', name: 'Super Admin', username: 'admin', password: '123', role: 'admin', disabled: false }];
            saveDb();
        }
        function saveDb() { dbRef.set(db); }
        function showScreen(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-' + id).classList.remove('hidden');
        }
        function togglePass(id, icon) {
            const el = document.getElementById(id);
            if (el.type === 'password') { el.type = 'text'; icon.innerText = 'üï∂Ô∏è'; }
            else { el.type = 'password'; icon.innerText = 'üëÅÔ∏è'; }
        }
        function emergencyReset() { if(confirm("Hapus SEMUA data?")) { dbRef.set(null); location.reload(); } }

        // --- LOGIN & AUTH ---
        function handleLogin() {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const found = (db.users||[]).find(x => x.username === u && x.password === p);
            if (found) {
                currentUser = found;
                localStorage.setItem('gkps_session', JSON.stringify(currentUser));
                if (found.role === 'siswa') { renderSiswaScreen(); showScreen('siswa'); }
                else { renderDashboardScreen(); showScreen('dashboard'); }
            } else { alert("Login Gagal!"); }
        }
        function logout() { localStorage.clear(); location.reload(); }

        // --- TABS & NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-pill').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            
            if (tab === 'scan') startProScanner(); else stopScanner();
        }

        // --- [CORE] LOGIKA SCANNER RESPONSIVE ---
        function startProScanner() {
            if (isScanning) return;
            if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

            const config = {
                fps: 30, 
                // Ukuran FIX 250px agar sama persis dengan CSS kotak biru, baik di HP maupun Laptop
                qrbox: { width: 250, height: 250 },
                // Hapus aspectRatio paksa agar menyesuaikan kamera laptop yg wide
                experimentalFeatures: { useBarCodeDetectorIfSupported: true }
            };

            html5QrCode.start({ facingMode: "environment" }, config, (text) => {
                if (text.startsWith('GKPS')) { processScan(text); }
            }).then(() => isScanning = true).catch(err => {
                document.getElementById('scanner-error').classList.remove('hidden');
                document.getElementById('scanner-error-msg').innerText = "Kamera tidak dapat diakses/ditemukan.";
            });
        }
        function stopScanner() {
            if (html5QrCode && isScanning) { html5QrCode.stop().then(() => isScanning = false); }
        }
        function processScan(qrData) {
            const parts = qrData.split('|');
            const username = parts[1];
            const today = new Date().toLocaleDateString('id-ID');
            
            if (!(db.attendance||[]).find(a => a.username === username && a.date === today)) {
                if (!db.attendance) db.attendance = [];
                db.attendance.push({ username, name: parts[2], date: today, time: new Date().toLocaleTimeString(), status: 'Hadir' });
                saveDb();
                showStatus("‚úÖ " + parts[2] + " HADIR", "green");
            } else { showStatus("‚ö†Ô∏è SUDAH ABSEN HARI INI", "yellow"); }
        }
        function showStatus(msg, color) {
            const el = document.getElementById('scan-status');
            el.innerText = msg;
            el.className = `mt-4 p-3 rounded-xl font-bold bg-${color}-100 text-${color}-800`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 2500);
        }

        // --- RENDER UI ---
        function updateUI() {
            if (currentUser && currentUser.role !== 'siswa') {
                renderHomeStats();
                renderUserTable();
                renderWhatsAppNotifications();
            }
        }
        function renderHomeStats() {
            const today = new Date().toLocaleDateString('id-ID');
            const logs = (db.attendance||[]).filter(a => a.date === today);
            document.getElementById('count-present').innerText = logs.length;
            document.getElementById('table-attendance').innerHTML = logs.slice().reverse().map(l => `
                <tr class="border-b text-sm"><td class="p-2">${l.time}</td><td class="p-2 font-bold">${l.name}</td><td class="p-2"><span class="badge badge-active">Hadir</span></td></tr>
            `).join('');
        }
        function renderUserTable() {
            document.getElementById('table-users').innerHTML = (db.users||[]).map(u => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2"><div class="font-bold text-xs">${u.name}</div><div class="text-[10px] text-gray-400">@${u.username}</div></td>
                    <td class="p-2 uppercase text-[10px] font-bold">${u.role}</td>
                    <td class="p-2"><span class="badge ${u.disabled?'badge-disabled':'badge-active'}">${u.disabled?'Blokir':'Aktif'}</span></td>
                    <td class="p-2 text-right"><button onclick="openUserModal('${u.id}')" class="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded font-bold">Edit</button></td>
                </tr>
            `).join('');
        }

        // --- [CORE] QR GENERATOR HIGH RES ---
        function renderSiswaScreen() {
            document.getElementById('siswa-greet-name').innerText = currentUser.name;
            document.getElementById('card-name-display').innerText = currentUser.name;
            document.getElementById('card-id-display').innerText = "ID: " + currentUser.username;
            document.getElementById('stu-avatar').src = currentUser.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+currentUser.name;
            document.getElementById('card-img').src = currentUser.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+currentUser.name;
            
            // Generate QR High Quality
            const codeData = `GKPS|${currentUser.username}|${currentUser.name}|siswa`;
            const container = document.getElementById("qrcode");
            container.innerHTML = ""; 
            new QRCode(container, {
                text: codeData,
                width: 1000, // Resolusi Besar
                height: 1000,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H // Toleransi Error Tinggi
            });
        }
        function renderDashboardScreen() {
            document.getElementById('role-badge').innerText = currentUser.role.replace('_',' ');
            document.getElementById('dash-avatar').src = currentUser.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+currentUser.name;
            if (currentUser.role === 'admin') {
                ['tab-users', 'tab-materi', 'tab-jadwal', 'tab-settings'].forEach(t => document.getElementById(t).classList.remove('hidden'));
            }
        }

        // --- MODAL & NOTIFICATIONS ---
        function renderWhatsAppNotifications() {
            const list = document.getElementById('dash-wa-list');
            const msgs = (db.messages||[]);
            list.innerHTML = msgs.length === 0 ? '<div class="text-center p-4 text-gray-400 text-xs italic">Belum ada pesan</div>' : msgs.map(m => `
                <div class="bg-white p-2 rounded shadow text-sm mb-1 border-l-4 border-green-500">${m.content}</div>
            `).join('');
        }
        function toggleNotificationPanel() { document.getElementById('dash-wa-panel').classList.toggle('show'); }
        function openUserModal(id=null) {
            document.getElementById('user-modal').style.display = 'flex';
            if (id) {
                const u = db.users.find(x => x.id === id);
                document.getElementById('modal-id').value = u.id;
                document.getElementById('modal-name').value = u.name;
                document.getElementById('modal-username').value = u.username;
                document.getElementById('modal-role').value = u.role;
            } else {
                document.getElementById('modal-id').value = '';
                document.getElementById('modal-name').value = '';
                document.getElementById('modal-username').value = '';
            }
        }
        function closeModal() { document.getElementById('user-modal').style.display = 'none'; }
        function saveUser() {
            const id = document.getElementById('modal-id').value;
            const name = document.getElementById('modal-name').value;
            const user = document.getElementById('modal-username').value;
            const role = document.getElementById('modal-role').value;
            
            if (id) {
                const idx = db.users.findIndex(x => x.id === id);
                db.users[idx] = { ...db.users[idx], name, username:user, role };
            } else {
                db.users.push({ id:'USR_'+Date.now(), name, username:user, password:'123', role, disabled:false });
            }
            saveDb(); closeModal(); renderUserTable();
        }

        // Jalankan Aplikasi
        window.onload = initApp;
    </script>
</body>
</html>
